<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Reservas - Temporada 2025/2026</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  
  

  <style>
:root {
    --cor-fundo: #f4f7f9;
    --cor-painel: #ffffff;
    --cor-borda: #e0e0e0;
    --cor-principal: #42A5F5; /* Azul Suave */
    --cor-principal-hover: #1E88E5;
    --cor-texto: #333;
    --cor-sombra: rgba(0, 0, 0, 0.08);
    --cor-entrada: #A5D8FF;
    --cor-saida: #FFAB91;
    --cor-hospedado: #C8E6C9;
    --cor-perigo: #dc3545;
    --cor-perigo-hover: #c82333;
  }

  body {
    font-family: 'Poppins', sans-serif; /* Nova Fonte */
    background: var(--cor-fundo);
    margin: 0;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }

  .sidebar {
    width: 350px;
    flex-shrink: 0;
    background: var(--cor-painel);
    padding: 20px;
    box-shadow: 4px 0 15px var(--cor-sombra);
    z-index: 1000; /* Z-index alto para ficar sobre o overlay */
    overflow-y: auto;
    height: 100vh;
    box-sizing: border-box;
    border-right: 1px solid var(--cor-borda);
    transition: transform 0.3s ease; /* Transi√ß√£o para o menu */
  }
  
  .sidebar h1 {
    font-size: 24px;
    margin-top: 0;
    margin-bottom: 30px;
    text-align: center;
    color: var(--cor-texto);
  }

  .content {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    height: 100vh;
    box-sizing: border-box;
    position: relative; /* Para o bot√£o de menu */
  }
  
  /* --- NOVOS ESTILOS PARA MENU HAMBURGUER E OVERLAY --- */
  .menu-toggle {
      display: none; /* Escondido no desktop */
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1050;
      background-color: var(--cor-principal);
      color: white;
      border: none;
      border-radius: 8px;
      width: 48px;
      height: 48px;
      font-size: 24px;
      padding: 0; /* Reset de padding */
      margin: 0; /* Reset de margin */
      justify-content: center;
      align-items: center;
  }
  .menu-toggle i {
      margin: 0; /* Reset de margem do √≠cone */
  }
  
  #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999; /* Abaixo do sidebar, acima do conte√∫do */
  }
  
  #overlay.ativo {
      display: block;
  }
  /* --- FIM DOS NOVOS ESTILOS --- */


  @media (max-width: 900px) {
    body {
        flex-direction: column;
        height: auto;
        overflow: auto;
    }
    .sidebar {
        /* Escondido por padr√£o no mobile */
        position: fixed;
        top: 0;
        left: 0;
        width: 300px; /* Largura fixa para o menu */
        max-width: 80%;
        height: 100%;
        box-shadow: 0 4px 10px var(--cor-sombra);
        transform: translateX(-100%);
    }
    .sidebar.ativo {
        transform: translateX(0); /* Mostra o menu */
    }
    .content {
        height: auto;
        overflow-y: visible;
        padding-top: 130px; /* Espa√ßo aumentado para menu + navega√ß√£o flutuante */
    }
    
    /* Mostra o bot√£o de menu */
    .menu-toggle {
        display: flex; 
    }
    
    /* *** NAVEGA√á√ÉO DE MESES FLUTUANTE NO MOBILE *** */
    .navegacao-mes {
        position: fixed;
        top: 68px; /* Abaixo do bot√£o de menu */
        left: 0;
        right: 0;
        z-index: 998; /* Abaixo do menu, mas acima do conte√∫do */
        margin-bottom: 0;
        border-radius: 0; /* Remove bordas arredondadas */
        box-shadow: 0 2px 8px var(--cor-sombra);
    }
    
    /* Otimiza√ß√£o dos bot√µes de navega√ß√£o */
    .navegacao-mes button {
        font-size: 18px; /* Aumenta o √≠cone */
        padding: 8px 12px; /* Ajusta padding */
    }
    .navegacao-mes button .texto-botao {
        display: none; /* Esconde o texto */
    }
    .navegacao-mes button i {
        margin: 0; /* Remove margem do √≠cone */
    }

    /* *** CORRE√á√ÉO DO LAYOUT DO CALEND√ÅRIO *** */
    #calendario-container {
        flex-direction: column; /* Empilha as unidades */
    }
  }

  /* --- ESTILOS DOS ELEMENTOS (mantidos) --- */
  button, .dia {
    min-width: 48px;
    min-height: 48px;
    font-size: 15px;
    padding: 8px;
    margin: 6px 0;
    border-radius: 8px;
  }
  
    .data-management h3,
    .controls h3 {
      color: var(--cor-texto);
      border-bottom: 1px solid var(--cor-borda);
      padding-bottom: 10px;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .dropdown {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    
    .dropbtn {
        width: 100%;
        padding: 10px 15px;
        font-size: 16px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    .dropbtn:hover {
        background-color: #5a6268;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 100;
      width: 100%;
      left: 0;
      right: 0;
      border: 1px solid var(--cor-borda);
      border-radius: 8px;
      overflow: hidden;
    }

    .dropdown-content button {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      background-color: #f1f1f1;
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
    }

    .dropdown-content button:hover {
      background-color: #ddd;
    }

    .dropdown:hover .dropdown-content {
      display: block;
    }

    .file-operations {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      align-items: center;
    }

    .controls button, .file-operations > button {
      padding: 10px 15px;
      font-size: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      background-color: var(--cor-principal);
      color: white;
      border: none;
      border-radius: 8px;
      transition: background-color 0.3s ease;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .controls button:hover, .file-operations > button:hover {
      background-color: var(--cor-principal-hover);
    }

    .controls button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .seguranca-ativada {
      background-color: var(--cor-perigo) !important;
    }
    .seguranca-ativada:hover {
      background-color: var(--cor-perigo-hover) !important;
    }
    
    hr {
      border: 0;
      border-top: 1px solid var(--cor-borda);
      margin: 20px 0;
    }
  .controls label,
    .controls select,
    .controls .checkbox-group {
      font-size: 15px;
      margin-bottom: 8px;
      display: block;
    }

    .controls select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      margin-bottom: 15px;
      font-family: 'Poppins', sans-serif;
    }
    
    .controls .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .controls .checkbox-group input {
      margin-right: 8px;
    }

    /* √çcones dentro dos bot√µes */
    button i {
        margin-right: 8px;
        font-size: 1.1em;
    }
    .dropdown-content button i {
        font-size: 1.2em;
    }
    .dropdown[style*="width: auto;"] .dropbtn {
        width: 48px;
        height: 48px;
        padding: 8px;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .dropdown[style*="width: auto;"] .dropbtn i {
        margin-right: 0;
    }

    /* --- ESTRUTURA DE CALEND√ÅRIO --- */
    .navegacao-mes {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: var(--cor-painel);
        padding: 10px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px var(--cor-sombra);
    }
    .navegacao-mes h2 {
        margin: 0;
        font-size: 22px;
        color: var(--cor-texto);
    }
    .navegacao-mes button {
        padding: 8px 16px;
        font-size: 15px;
        background-color: var(--cor-principal);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    .navegacao-mes button:disabled { background-color: #ccc; }
    .navegacao-mes button:hover:not(:disabled) { background-color: var(--cor-principal-hover); }
    .navegacao-mes button:last-child i { margin-right: 0; margin-left: 8px; }
    
    #calendario-container {
        display: flex;
        gap: 20px;
        width: 100%;
    }

    .unidade-coluna {
        flex: 1;
        background: var(--cor-painel);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px var(--cor-sombra);
    }
    
    .dias {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 5px;
    }

    .dia {
      background: #e9ecef; 
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border-radius: 8px;
      min-height: 60px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      box-shadow: none; 
      border: 1px solid #dee2e6;
      position: relative;
      transition: all 0.2s ease;
    }
    .dia:hover {
        border-color: var(--cor-principal);
    }
    .dia.filtered-out { opacity: 0.3; }
    .dia.filtered-in { transform: scale(1.05); box-shadow: 0 0 10px var(--cor-principal); border-color: var(--cor-principal); }
    .dia.seguranca-ativada { cursor: not-allowed; opacity: 0.5; }
    .dia strong { font-size: 14px; margin-bottom: 5px; font-weight: 500; }
    .dia div { margin: 2px 0; font-size: 10px; line-height: 1.2; }
    
    .entrada { background-color: var(--cor-entrada) !important; border-color: #8ecfff !important; }
    .saida { background-color: var(--cor-saida) !important; border-color: #ff8a65 !important; }
    .hospedado { background-color: var(--cor-hospedado) !important; border-color: #a5d6a7 !important; }
    .dupla { background: linear-gradient(135deg, var(--cor-saida) 50%, var(--cor-entrada) 50%) !important; }

    .dia .bi { font-size: 1.1em; }
    .icon-hospedado { color: #155724; }
    .icon-entrada { color: #004085; }
    .icon-saida { color: #721c24; }
    .icon-troca { color: #856404; }


    #tooltip {
  transition: opacity 0.25s ease;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  border-radius: 10px;
 display: none; position: absolute; z-index: 9999; background: #fff; border: 1px solid #ccc; padding: 6px; font-size: 12px; white-space: nowrap; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); pointer-events: auto; border-radius: 8px; }
    
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 700px; position: relative; }
    .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #555; }
    .modal-content h3 { color: #555; border-bottom: 1px solid var(--cor-borda); padding-bottom: 10px; margin-bottom: 15px; }
    .modal-tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
    .tab-btn { padding: 10px 15px; cursor: pointer; border: none; background-color: transparent; border-bottom: 3px solid transparent; font-size: 16px; }
    .tab-btn.active { border-bottom: 3px solid var(--cor-principal); font-weight: bold; }
    .report-content { display: none; }
    .report-content.active { display: block; max-height: 60vh; overflow-y: auto; padding-right: 10px; }
    
    /* ESTILOS PARA O M√ìDULO FINANCEIRO */
    #listaReservasFinanceiro button { width: 100%; text-align: left; margin-bottom: 5px; background-color: #f1f1f1; border: 1px solid #ddd; }
    .form-financeiro-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .form-financeiro-grid label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
    .form-financeiro-grid input, .form-financeiro-grid select { width: 100%; padding: 8px; box-sizing: border-box; font-family: 'Poppins', sans-serif; border: 1px solid #ccc; border-radius: 8px; }
    table.relatorio-financeiro { width: 100%; border-collapse: collapse; font-size: 12px; }
    table.relatorio-financeiro th, table.relatorio-financeiro td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    table.relatorio-financeiro th { background-color: #f2f2f2; }
    table.relatorio-financeiro tfoot { font-weight: bold; }
    
    /* CSS DO RELAT√ìRIO VISUAL (COMO NA VERS√ÉO ANTERIOR) */
    .unidade-relatorio { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .unidade-relatorio:last-child { border-bottom: none; }
    .unidade-relatorio h4 { color: var(--cor-principal); margin-top: 0; margin-bottom: 15px; text-align: center; }
    .mes-relatorio { margin-bottom: 20px; }
    .mes-relatorio h5 { text-align: center; margin: 5px 0 10px 0; font-weight: 500; color: #555; }
    .dias-relatorio { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 12px; }
    .dia-relatorio { display: flex; justify-content: center; align-items: center; height: 30px; background-color: #f0f0f0; border-radius: 4px; border: 1px solid #ddd; }
    .dia-relatorio.header { font-weight: bold; background-color: transparent; border: none; color: #666; }
    .dia-relatorio.noite-ocupada { background-color: var(--cor-saida); color: #a22; font-weight: bold; border-color: #ff8a65; }
    .dia-relatorio.troca { background-color: #ffc107; color: #7d5900; font-weight: bold; border-color: #ffb300; }
    .dia-relatorio.checkout-apenas { background: linear-gradient(135deg, #f0f0f0 49%, #ffe8e8 51%); border-color: #fcc; }



/* --- IN√çCIO: ESTILOS PARA RELAT√ìRIO VISUAL (FALTANDO) --- */
    .unidade-relatorio {
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }
    .unidade-relatorio:last-child {
      border-bottom: none;
    }
    .unidade-relatorio h4 {
      color: var(--cor-principal);
      margin-top: 0;
      margin-bottom: 15px; /* Adicionado espa√ßo */
      text-align: center; /* Centralizar t√≠tulo da unidade */
    }
    .mes-relatorio {
        margin-bottom: 20px; /* Aumentado espa√ßo entre meses */
    }
    .mes-relatorio h5 {
        text-align: center;
        margin: 5px 0 10px 0; /* Ajustado espa√ßamento */
        font-weight: 500;
        color: #555;
    }
    .dias-relatorio {
        display: grid;
        grid-template-columns: repeat(7, 1fr); /* Define 7 colunas */
        gap: 4px;
        font-size: 12px;
    }
    .dia-relatorio {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 30px; /* Altura de cada c√©lula */
        background-color: #f0f0f0;
        border-radius: 4px;
        border: 1px solid #ddd; /* Borda sutil */
    }
    .dia-relatorio.header {
        font-weight: bold;
        background-color: transparent;
        border: none; /* Sem borda no cabe√ßalho */
        color: #666;
    }
    .dia-relatorio.noite-ocupada {
        background-color: var(--cor-saida); /* Usa a cor de sa√≠da */
        color: #a22;
        font-weight: bold;
        border-color: #ff8a65;
    }
    .dia-relatorio.troca {
        background-color: #ffc107; /* Amarelo para troca */
        color: #7d5900;
        font-weight: bold;
        border-color: #ffb300;
    }
    .dia-relatorio.checkout-apenas {
        /* Metade fundo, metade cor de sa√≠da suave */
        background: linear-gradient(135deg, #f0f0f0 49%, #ffe8e8 51%);
        border-color: #fcc;
    }
    /* --- FIM: ESTILOS PARA RELAT√ìRIO VISUAL --- */

    
    @media print {
      body > *:not(.modal-overlay) { display: none !important; }
      .modal-overlay { position: relative; background: none; }
      .modal-content { box-shadow: none; max-width: 100%; width: 100%; max-height: none; overflow-y: visible; }
      .modal-close-btn, .modal-tabs, .print-btn, .modal-content h3 ~ div[style] { display: none !important; }
    }

    /* --- IN√çCIO: ESTILOS PARA CONTROLE DE LIMPEZA --- */
    #tabelaLimpeza .status-pendente {
        color: #856404; /* Amarelo escuro */
        font-weight: bold;
    }
    #tabelaLimpeza .status-concluida {
        color: #155724; /* Verde escuro */
        font-weight: bold;
    }
    #tabelaLimpeza button {
        padding: 4px 8px;
        font-size: 12px;
        margin: 0;
        width: auto;
    }
    #tabelaLimpeza .limpeza-editada {
        background-color: #ffe6e6 !important;
        border-left: 4px solid var(--cor-perigo) !important;
    }
    #tabelaLimpeza .limpeza-editada td {
        color: var(--cor-perigo) !important;
        font-weight: bold !important;
    }
    #tabelaLimpeza .icone-editada {
        color: var(--cor-perigo);
        margin-right: 5px;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    /* --- FIM: ESTILOS PARA CONTROLE DE LIMPEZA --- */
/* Estilos do bot√£o Hoje */
.btn-hoje {
    padding: 6px 12px;
    font-size: 14px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: background-color 0.3s ease;
}

.btn-hoje:hover {
    background-color: #218838;
}

.btn-hoje i {
    font-size: 16px;
}

@media (max-width: 900px) {
    .btn-hoje .texto-botao {
        display: none;
    }
    .btn-hoje {
        padding: 6px 10px;
        min-width: auto;
    }
}

/* ========================================
   MELHORIAS VISUAIS - CONTROLE DE LIMPEZA
   ======================================== */

/* Tabela de Limpeza Moderna */
#tabelaLimpeza {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-radius: 8px;
    overflow: hidden;
}

#tabelaLimpeza thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

#tabelaLimpeza thead th {
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: none;
}

#tabelaLimpeza tbody tr {
    background-color: #ffffff;
    transition: all 0.2s ease;
}

#tabelaLimpeza tbody tr:nth-child(even) {
    background-color: #f8f9fa;
}

#tabelaLimpeza tbody tr:hover {
    background-color: #e3f2fd;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

#tabelaLimpeza tbody td {
    padding: 14px 12px;
    border-bottom: 1px solid #e9ecef;
    font-size: 14px;
    color: #495057;
}

#tabelaLimpeza tbody tr:last-child td {
    border-bottom: none;
}

/* Coluna de Data */
#tabelaLimpeza tbody td:first-child {
    font-weight: 500;
    color: #667eea;
}

/* Coluna de Unidade */
#tabelaLimpeza tbody td:nth-child(2) {
    font-weight: 600;
    color: #2c3e50;
}

/* Coluna de Tipo */
#tabelaLimpeza tbody td:nth-child(3) {
    color: #6c757d;
}

/* Bot√£o Marcar Conclu√≠da - Modernizado */
#tabelaLimpeza button {
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 500;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Bot√£o Pendente */
#tabelaLimpeza button:not(.concluida-btn) {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

#tabelaLimpeza button:not(.concluida-btn):hover {
    background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
}

/* Bot√£o Conclu√≠da */
#tabelaLimpeza button.concluida-btn {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
    cursor: default;
}

#tabelaLimpeza button.concluida-btn:hover {
    transform: none;
}

/* Container da tabela com scroll */
.tabela-limpeza-container {
    max-height: 400px;
    overflow-y: auto;
    border-radius: 8px;
}

/* Scroll personalizado */
.tabela-limpeza-container::-webkit-scrollbar {
    width: 8px;
}

.tabela-limpeza-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.tabela-limpeza-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
}

.tabela-limpeza-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
}

/* Responsividade para mobile */
@media (max-width: 768px) {
    #tabelaLimpeza {
        font-size: 12px;
    }
    
    #tabelaLimpeza thead th,
    #tabelaLimpeza tbody td {
        padding: 10px 8px;
    }
    
    #tabelaLimpeza button {
        padding: 6px 12px;
        font-size: 11px;
    }
}


  


/* --- Tooltip Apar√™ncia Aprimorada (V4.3 - com visibilidade corrigida) --- */
#tooltip {
  display: none;
  background: rgba(255, 255, 255, 0.96);
  border: 1px solid rgba(0, 0, 0, 0.08);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: opacity 0.2s ease, transform 0.2s ease;
  transform-origin: top left;
}
#tooltip.mostrar {
  display: block;
  opacity: 1;
  transform: translateY(0);
}
#tooltip:not(.mostrar) {
  opacity: 0;
  transform: translateY(6px);
}

</style>
</head>

<body>
  <aside class="sidebar">
    <h1>Controle de Reservas</h1>
    <div class="sidebar-content">
        <div class="data-management">
            <h3>Gerenciamento de Dados:</h3>
            <div class="dropdown">
              <button class="dropbtn"><i class="bi bi-hdd-stack"></i> Gerenciar Dados Locais</button>
              <div class="dropdown-content">
                <button id="salvarLocalmenteBtn"><i class="bi bi-save"></i> Salvar Localmente</button>
                <button id="limparDadosLocaisBtn"><i class="bi bi-trash"></i> Limpar Dados Locais</button>
                <div style="padding: 12px 16px; background-color: #f1f1f1;">
                  <label for="autoBackupToggle" style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="autoBackupToggle" style="margin-right: 10px;">
                    Backup autom√°tico
                  </label>
                </div>
              </div>
            </div>
            <hr>
            <div class="file-operations">
              <div class="dropdown">
                <button class="dropbtn"><i class="bi bi-arrow-down-up"></i> Importar / Exportar</button>
                <div class="dropdown-content">
                  <h4 style="padding: 10px 16px; margin: 0; background: #eee;">Importar</h4>
                  <button id="importarBackupCompletoBtn"><i class="bi bi-file-earmark-zip"></i> Importar Backup Completo (.json)</button>
                  <button id="importarClientesBtn"><i class="bi bi-file-earmark-person"></i> Importar Apenas Clientes (.txt)</button>
                  
                  <hr style="margin: 5px 0;">
                  <h4 style="padding: 10px 16px; margin: 0; background: #eee;">Exportar</h4>
                  <button id="exportarBackupCompletoBtn"><i class="bi bi-file-earmark-zip-fill"></i> Exportar Backup Completo (.json)</button>
                  <button id="exportarClientesBtn"><i class="bi bi-person-lines-fill"></i> Exportar Apenas Clientes (.txt)</button>
                  <button id="exportarReservasTXTBtn"><i class="bi bi-file-earmark-text"></i> Exportar Apenas Reservas (.txt)</button>
                  <button id="exportarFinanceiroJSONBtn"><i class="bi bi-cash-stack"></i> Exportar Apenas Financeiro (.json)</button> 
                </div>
              </div>
              <button id="segurancaBtn"><i class="bi bi-unlock-fill"></i> Seguran√ßa Desativada</button>
              <input type="file" id="importarBackupCompletoInput" accept=".json" style="display: none;" aria-label="Importar Backup Completo">
              <input type="file" id="importarClientesInput" accept=".txt" style="display: none;" aria-label="Importar Apenas Clientes">
            </div>
          </div>

          <hr>

          <div class="controls">
            <h3>Controles e Filtros:</h3>
            <button id="configurarTemporadaBtn"><i class="bi bi-gear-fill"></i> Configurar Temporada</button>
            <button id="ajudaBtn"><i class="bi bi-question-circle"></i> Ajuda & Legenda</button>
            <button id="gerarRelatorioBtn"><i class="bi bi-bar-chart-line"></i> Relat√≥rio de Ocupa√ß√£o</button>
            <button id="gerenciarFinanceiroBtn" disabled><i class="bi bi-cash-coin"></i> Gerenciar Financeiro</button>
            <button id="gerarRelatorioFinanceiroBtn"><i class="bi bi-graph-up"></i> Relat√≥rio Financeiro</button>
    
            <hr>
            <button id="verControleLimpezaBtn"><i class="bi bi-check2-square"></i> Controle de Limpeza</button>
            <button id="agendarLimpezaExtraBtn"><i class="bi bi-magic"></i> Agendar Limpeza Extra</button>
            
            <div class="filter-group">
              <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px;">
                <div style="flex-grow: 1;">
                  <label for="clienteSelect">Filtrar por Cliente:</label>
                  <select id="clienteSelect">
                    <option value="">-- Todos os Clientes --</option>
                  </select>
                </div>
                <div class="dropdown" style="width: auto;">
                  <button class="dropbtn" style="width: auto;" aria-label="A√ß√µes do Cliente"><i class="bi bi-gear-fill"></i></button>
                  <div class="dropdown-content">
                    <button id="adicionarClienteBtn"><i class="bi bi-person-plus"></i> Adicionar Novo Cliente</button>
                    <button id="editarClienteBtn" disabled><i class="bi bi-pencil"></i> Editar Selecionado</button>
                    <button id="removerClienteBtn" disabled><i class="bi bi-person-dash"></i> Remover Selecionado</button>
                  </div>
                </div>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="filtroResvCheckbox">
                <label for="filtroResvCheckbox" style="display: inline; margin-bottom: 0;">Apenas clientes com status "Resv"</label>
              </div>
            </div>
          </div>
    </div>
  </aside>

  <main class="content">
    <button id="menu-toggle-btn" class="menu-toggle" aria-label="Abrir menu"><i class="bi bi-list"></i></button>
    <div id="overlay"></div> 
    
    <div class="navegacao-mes">
        <button id="mesAnteriorBtn"><i class="bi bi-chevron-left"></i> <span class="texto-botao">Anterior</span></button>
        <div style="display: flex; align-items: center; gap: 10px;">
            <h2 id="mesAtualDisplay"></h2>
            <button id="mesHojeBtn" class="btn-hoje" title="Ir para o m√™s atual"><i class="bi bi-calendar-check"></i> <span class="texto-botao">Hoje</span></button>
        </div>
        <button id="mesProximoBtn" style="flex-direction: row-reverse;"><span class="texto-botao">Pr√≥ximo</span> <i class="bi bi-chevron-right"></i></button>
    </div>
    <div id="calendario-container"></div>
  </main>

  <div id="tooltip"></div>
  <div id="modalAjuda" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <span class="modal-close-btn">&times;</span>
      <h3><i class="bi bi-palette"></i> Legenda</h3>
      <ul style="list-style: none; padding: 0;">
        <li style="display: flex; align-items: center; margin-bottom: 8px;"><span style="width: 20px; height: 20px; margin-right: 10px; border-radius: 4px; background-color: var(--cor-entrada);"></span> Entrada</li>
        <li style="display: flex; align-items: center; margin-bottom: 8px;"><span style="width: 20px; height: 20px; margin-right: 10px; border-radius: 4px; background-color: var(--cor-saida);"></span> Sa√≠da</li>
        <li style="display: flex; align-items: center; margin-bottom: 8px;"><span style="width: 20px; height: 20px; margin-right: 10px; border-radius: 4px; background: linear-gradient(135deg, var(--cor-saida) 50%, var(--cor-entrada) 50%);"></span> Entrada/Sa√≠da</li>
        <li style="display: flex; align-items: center; margin-bottom: 8px;"><span style="width: 20px; height: 20px; margin-right: 10px; border-radius: 4px; background-color: var(--cor-hospedado);"></span> Hospedado</li>
      </ul>
      <hr>
      <h3><i class="bi bi-mouse"></i> L√≥gica de Cliques</h3>
      <ul>
        <li>1¬∫ Clique ‚Üí <i class="bi bi-box-arrow-in-right icon-entrada"></i> Marca como Entrada</li>
        <li>2¬∫ Clique ‚Üí <i class="bi bi-check-circle-fill icon-hospedado"></i> Marca como Hospedado</li>
        <li>3¬∫ Clique ‚Üí <i class="bi bi-box-arrow-left icon-saida"></i> Marca como Sa√≠da</li>
        <li>4¬∫ Clique ‚Üí ‚ö™ Limpa a marca√ß√£o do cliente atual</li>
      </ul>
      <p><strong>Observa√ß√£o:</strong> Para limpar todas as marca√ß√µes de um dia (de todos os clientes), use o bot√£o direito do mouse ou d√™ um duplo clique no dia.</p>
    </div>
  </div>

  <div id="modalRelatorio" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <span class="modal-close-btn">&times;</span>
      <h3><i class="bi bi-bar-chart-line"></i> Relat√≥rio de Ocupa√ß√£o</h3>
      <div class="modal-tabs">
        <button class="tab-btn active" data-target="relatorioConteudoTexto">Resumo em Texto</button>
        <button class="tab-btn" data-target="relatorioConteudoVisual">Visualiza√ß√£o em Calend√°rio</button>
      </div>
      <div id="relatorioConteudoTexto" class="report-content active"></div>
      <div id="relatorioConteudoVisual" class="report-content"></div>
      <div style="text-align: right; margin-top: 20px;">
        <button class="print-btn" ><i class="bi bi-printer"></i> Imprimir</button>
      </div>
    </div>
  </div>

  <div id="modalCliente" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <span class="modal-close-btn">&times;</span>
      <h3 id="modalClienteTitulo">Adicionar Novo Cliente</h3>
      <form id="formCliente">
        <input type="hidden" id="clienteOriginalNomeInput">
        <div style="margin-bottom: 15px;"><label for="clienteNomeInput">Nome:</label><input type="text" id="clienteNomeInput" required style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;"></div>
        <div style="margin-bottom: 15px;"><label for="clienteWhatsInput">WhatsApp (com DDI):</label><input type="text" id="clienteWhatsInput" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;"></div>
        <div style="margin-bottom: 15px;"><label for="clientePaisInput">Pa√≠s:</label><input type="text" id="clientePaisInput" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;"></div>
        <div style="margin-bottom: 15px;"><label for="clienteTempoInput">Temporada:</label><input type="text" id="clienteTempoInput" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;"></div>
        <div style="margin-bottom: 15px;"><label for="clienteUnidadeInput">Unidade Preferencial:</label><input type="text" id="clienteUnidadeInput" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;"></div>
        <div style="margin-bottom: 15px;"><label for="clienteStatusInput">Status (Resv/Cons/Outr):</label><input type="text" id="clienteStatusInput" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;"></div>
        <button type="submit" id="salvarClienteBtn" style="width: 100%; padding: 12px; font-size: 18px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Salvar Cliente</button>
      </form>
    </div>
  </div>

  <div id="modalFinanceiro" class="modal-overlay" style="display: none;">
      <div class="modal-content">
          <span class="modal-close-btn">&times;</span>
          <h3 id="modalFinanceiroTitulo"><i class="bi bi-cash-coin"></i> Dados Financeiros da Reserva</h3>
          <div id="infoReservaFinanceiro" style="margin-bottom: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;"></div>
          <div id="listaReservasFinanceiro"></div>
          <form id="formFinanceiro" style="display: none;">
              <input type="hidden" id="reservaIdInput">
              <div class="form-financeiro-grid">
                  <div><label for="valorDiariaInput">Valor da Di√°ria (R$)</label><input type="number" id="valorDiariaInput" step="0.01" min="0"></div>
                  <div><label for="valorSinalInput">Valor do Sinal (R$)</label><input type="number" id="valorSinalInput" step="0.01" min="0"></div>
                  <div><label for="dataPagSinalInput">Data Pag. Sinal</label><input type="date" id="dataPagSinalInput"></div>
                  <div><label for="formaPagSinalInput">Forma Pag. Sinal</label><select id="formaPagSinalInput"><option value="">-- Selecione --</option><option value="PIX">PIX</option><option value="Transfer√™ncia">Transfer√™ncia</option><option value="Dinheiro">Dinheiro</option><option value="Cart√£o">Cart√£o</option><option value="Outro">Outro</option></select></div>
              </div>
              <hr>
              <button type="submit" style="width: 100%; padding: 12px; font-size: 18px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;"><i class="bi bi-save"></i> Salvar Dados Financeiros</button>
          </form>
      </div>
  </div>

  <div id="modalRelatorioFinanceiro" class="modal-overlay" style="display: none;">
      <div class="modal-content">
          <span class="modal-close-btn">&times;</span>
          <h3><i class="bi bi-graph-up"></i> Relat√≥rio Financeiro</h3>
          <div id="relatorioFinanceiroConteudo" class="report-content active"></div>
          <div style="text-align: right; margin-top: 20px;">
              <button class="print-btn" ><i class="bi bi-printer"></i> Imprimir</button>
          </div>
      </div>
  </div>

  <div id="modalControleLimpeza" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--cor-borda); padding-bottom: 10px; margin-bottom: 15px;">
            <h3 style="border: none; margin: 0; padding: 0;"><i class="bi bi-check2-square"></i> Controle de Limpeza</h3>
            <div style="display: flex; gap: 10px;">
                <button id="limparMarcacoesBtn" class="print-btn" style="padding: 6px 12px; font-size: 14px; margin: 0; background-color: #dc3545; border: none; color: white; border-radius: 8px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#c82333'" onmouseout="this.style.backgroundColor='#dc3545'">
                    <i class="bi bi-x-circle"></i> Limpar Marca√ß√µes
                </button>
                <button id="enviarLimpezaWhatsAppBtn" class="print-btn" style="padding: 6px 12px; font-size: 14px; margin: 0; background-color: #25D366; border: none; color: white; border-radius: 8px; cursor: pointer; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#128C7E'" onmouseout="this.style.backgroundColor='#25D366'">
                    <i class="bi bi-whatsapp"></i> Enviar Lista
                </button>
            </div>
        </div>

        <div id="tabelaLimpezaContainer" class="report-content active">
            <table class="relatorio-financeiro" id="tabelaLimpeza">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Unidade</th>
                        <th>Tipo</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
  </div>
  <div id="modalAgendarLimpeza" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <span class="modal-close-btn">&times;</span>
      <h3><i class="bi bi-magic"></i> Agendar Limpeza Extra/Manual</h3>
      <form id="formLimpezaExtra">
        <div class="form-financeiro-grid">
            <div>
                <label for="limpezaUnidadeSelect">Unidade:</label>
                <select id="limpezaUnidadeSelect" required>
                    <option value="UN01">UN01</option>
                    <option value="UN02">UN02</option>
                    <option value="UN03">UN03</option>
                </select>
            </div>
            <div>
                <label for="limpezaDataInput">Data:</label>
                <input type="date" id="limpezaDataInput" required>
            </div>
            <div>
                <label for="limpezaTipoSelect">Tipo:</label>
                <select id="limpezaTipoSelect" required>
                    <option value="Limpeza Extra">Limpeza Extra</option>
                    <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>
        </div>
        <hr>
        <button type="submit" style="width: 100%; padding: 12px; font-size: 18px; background-color: var(--cor-principal); color: white; border: none; border-radius: 5px; cursor: pointer;">Salvar Agendamento</button>
      </form>
    </div>
  </div>
  <!-- Modal de Configura√ß√£o de Temporada -->
  <div id="modalConfigurarTemporada" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <span class="modal-close-btn">&times;</span>
      <h3><i class="bi bi-gear-fill"></i> Configurar Temporada</h3>
      
      <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <p style="margin: 0; color: #856404;"><strong>‚ö†Ô∏è Aten√ß√£o:</strong> Alterar estas configura√ß√µes pode afetar os dados existentes. Recomenda-se fazer um backup antes de prosseguir.</p>
      </div>

      <form id="formConfigurarTemporada">
        <h4 style="margin-top: 0; border-bottom: 1px solid var(--cor-borda); padding-bottom: 10px;">üìÖ Per√≠odo da Temporada</h4>
        
        <div class="form-financeiro-grid">
          <div>
            <label for="dataInicioTemporada">Data Inicial:</label>
            <input type="date" id="dataInicioTemporada" required>
          </div>
          <div>
            <label for="dataFimTemporada">Data Final:</label>
            <input type="date" id="dataFimTemporada" required>
          </div>
        </div>

        <h4 style="margin-top: 25px; border-bottom: 1px solid var(--cor-borda); padding-bottom: 10px;">üè† Unidades</h4>
        
        <div style="margin-bottom: 15px;">
          <label for="numeroUnidades">N√∫mero de Unidades:</label>
          <input type="number" id="numeroUnidades" min="1" max="20" value="3" required style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
          <small style="color: #666;">M√≠nimo: 1 | M√°ximo: 20</small>
        </div>

        <div id="containerNomesUnidades" style="margin-top: 15px;">
          <!-- Campos de nomes de unidades ser√£o gerados dinamicamente aqui -->
        </div>

        <hr>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" id="btnResetarPadrao" style="padding: 12px 20px; font-size: 16px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
            <i class="bi bi-arrow-counterclockwise"></i> Resetar Padr√£o
          </button>
          <button type="submit" style="padding: 12px 20px; font-size: 16px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
            <i class="bi bi-check-circle"></i> Aplicar Configura√ß√µes
          </button>
        </div>
      </form>
    </div>
  </div>

    

  <script>
(function() {
    // VARI√ÅVEIS GLOBAIS
    let clientes = [], dadosFinanceiros = [], dadosLimpeza = [];
    // *** IN√çCIO: MODIFICA√á√ÉO (FEATURE 2) - Vari√°vel de rastreamento ***
    let ultimaAcaoLimpeza = { acao: null, data: null, unidade: null };
    // *** FIM: MODIFICA√á√ÉO (FEATURE 2) ***
    let clienteSelecionado = null;
    let segurancaAtivada = false;
    let mesAtualIndex = 0;
    let tooltipTimeout;

    const LOCAL_STORAGE_KEY_RESERVAS = 'dadosReservasTemporada2025_2026';
    const LOCAL_STORAGE_KEY_CLIENTES = 'clientesTemporada2025_2026';
    const LOCAL_STORAGE_KEY_FINANCEIRO = 'financeiroTemporada2025_2026';
    const LOCAL_STORAGE_KEY_LIMPEZA = 'limpezaTemporada2025_2026';

    // ========================================
    // SISTEMA DE CONFIGURA√á√ÉO DE TEMPORADA
    // ========================================
    
    const LOCAL_STORAGE_KEY_CONFIG = 'configuracaoTemporada2025_2026';
    
    // Configura√ß√£o padr√£o
    const CONFIG_PADRAO = {
        dataInicio: '2025-11-01',
        dataFim: '2026-05-31',
        unidades: ['UN01', 'UN02', 'UN03']
    };
    
    let configuracaoAtual = null;
    
    // Carregar ou inicializar configura√ß√£o
    function carregarConfiguracao() {
        const configSalva = localStorage.getItem(LOCAL_STORAGE_KEY_CONFIG);
        if (configSalva) {
            try {
                configuracaoAtual = JSON.parse(configSalva);
            } catch (e) {
                console.error('Erro ao carregar configura√ß√£o:', e);
                configuracaoAtual = { ...CONFIG_PADRAO };
            }
        } else {
            configuracaoAtual = { ...CONFIG_PADRAO };
        }
        return configuracaoAtual;
    }
    
    // Salvar configura√ß√£o
    function salvarConfiguracao(config) {
        localStorage.setItem(LOCAL_STORAGE_KEY_CONFIG, JSON.stringify(config));
        configuracaoAtual = config;
    }
    
    // Gerar lista de meses a partir da configura√ß√£o
    function gerarMesesDaConfiguracao(config) {
        const mesesGerados = [];
        const dataInicio = new Date(config.dataInicio + 'T00:00:00');
        const dataFim = new Date(config.dataFim + 'T00:00:00');
        
        const nomesMeses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                           "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        
        let dataAtual = new Date(dataInicio);
        
        while (dataAtual <= dataFim) {
            const mes = dataAtual.getMonth();
            const ano = dataAtual.getFullYear();
            const nomeMes = nomesMeses[mes];
            
            // Calcular n√∫mero de dias do m√™s
            const ultimoDia = new Date(ano, mes + 1, 0).getDate();
            
            // Verificar se √© o primeiro ou √∫ltimo m√™s (pode ter dias parciais)
            let diasNoMes = ultimoDia;
            
            // Se √© o primeiro m√™s, come√ßar do dia especificado
            if (dataAtual.getTime() === dataInicio.getTime()) {
                diasNoMes = ultimoDia - dataInicio.getDate() + 1;
            }
            
            // Se √© o √∫ltimo m√™s, terminar no dia especificado
            const proximoMes = new Date(ano, mes + 1, 1);
            if (proximoMes > dataFim) {
                diasNoMes = dataFim.getDate();
            }
            
            mesesGerados.push({
                nome: nomeMes,
                ano: ano,
                dias: diasNoMes,
                diaInicio: (dataAtual.getTime() === dataInicio.getTime()) ? dataInicio.getDate() : 1
            });
            
            // Avan√ßar para o pr√≥ximo m√™s
            dataAtual = new Date(ano, mes + 1, 1);
        }
        
        return mesesGerados;
    }
    
    // Abrir modal de configura√ß√£o
    function abrirModalConfigurarTemporada() {
        const modal = document.getElementById('modalConfigurarTemporada');
        if (!modal) return;
        
        const config = carregarConfiguracao();
        
        // Preencher campos
        document.getElementById('dataInicioTemporada').value = config.dataInicio;
        document.getElementById('dataFimTemporada').value = config.dataFim;
        document.getElementById('numeroUnidades').value = config.unidades.length;
        
        // Gerar campos de nomes de unidades
        gerarCamposNomesUnidades(config.unidades.length, config.unidades);
        
        modal.style.display = 'flex';
    }
    
    // Gerar campos para nomear unidades
    function gerarCamposNomesUnidades(quantidade, nomesAtuais = []) {
        const container = document.getElementById('containerNomesUnidades');
        if (!container) return;
        
        container.innerHTML = '<label style="font-weight: 500; margin-bottom: 10px; display: block;">Nomes das Unidades:</label>';
        
        const grid = document.createElement('div');
        grid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;';
        
        for (let i = 0; i < quantidade; i++) {
            const div = document.createElement('div');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'input-nome-unidade';
            input.placeholder = `Unidade ${i + 1}`;
            input.value = nomesAtuais[i] || `UN${String(i + 1).padStart(2, '0')}`;
            input.style.cssText = 'width: 100%; padding: 8px; font-size: 14px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px;';
            input.maxLength = 10;
            div.appendChild(input);
            grid.appendChild(div);
        }
        
        container.appendChild(grid);
    }
    
    // Listener para mudan√ßa no n√∫mero de unidades
    function setupNumeroUnidadesListener() {
        const numeroUnidadesInput = document.getElementById('numeroUnidades');
        if (numeroUnidadesInput) {
            numeroUnidadesInput.addEventListener('input', (e) => {
                const quantidade = parseInt(e.target.value) || 1;
                gerarCamposNomesUnidades(quantidade);
            });
        }
    }
    
    // Resetar para configura√ß√£o padr√£o
    function resetarConfiguracaoPadrao() {
        if (!confirm('Tem certeza que deseja resetar para a configura√ß√£o padr√£o?\n\nIsso ir√°:\n- Per√≠odo: 01/11/2025 a 31/05/2026\n- Unidades: UN01, UN02, UN03\n\nOs dados de reservas existentes ser√£o mantidos.')) {
            return;
        }
        
        document.getElementById('dataInicioTemporada').value = CONFIG_PADRAO.dataInicio;
        document.getElementById('dataFimTemporada').value = CONFIG_PADRAO.dataFim;
        document.getElementById('numeroUnidades').value = CONFIG_PADRAO.unidades.length;
        gerarCamposNomesUnidades(CONFIG_PADRAO.unidades.length, CONFIG_PADRAO.unidades);
        
        showNotification('Configura√ß√£o resetada para o padr√£o. Clique em "Aplicar Configura√ß√µes" para salvar.', 'info');
    }
    
    // Aplicar configura√ß√µes
    function aplicarConfiguracoes(e) {
        e.preventDefault();
        
        const dataInicio = document.getElementById('dataInicioTemporada').value;
        const dataFim = document.getElementById('dataFimTemporada').value;
        
        // Valida√ß√µes
        if (new Date(dataInicio) >= new Date(dataFim)) {
            showNotification('A data inicial deve ser anterior √† data final!', 'error');
            return;
        }
        
        // Coletar nomes das unidades
        const inputsNomes = document.querySelectorAll('.input-nome-unidade');
        const unidades = Array.from(inputsNomes).map(input => input.value.trim()).filter(nome => nome);
        
        if (unidades.length === 0) {
            showNotification('Voc√™ deve definir pelo menos uma unidade!', 'error');
            return;
        }
        
        // Verificar nomes duplicados
        const nomesUnicos = new Set(unidades);
        if (nomesUnicos.size !== unidades.length) {
            showNotification('Existem nomes de unidades duplicados! Cada unidade deve ter um nome √∫nico.', 'error');
            return;
        }
        
        // Confirmar aplica√ß√£o
        const confirmMsg = `Confirma a aplica√ß√£o das seguintes configura√ß√µes?\n\n` +
                          `üìÖ Per√≠odo: ${formatarData(dataInicio)} a ${formatarData(dataFim)}\n` +
                          `üè† Unidades: ${unidades.join(', ')}\n\n` +
                          `O calend√°rio ser√° recriado com as novas configura√ß√µes.`;
        
        if (!confirm(confirmMsg)) {
            return;
        }
        
        // Salvar backup autom√°tico antes de aplicar
        const backupAntes = {
            reservas: coletarDadosDeReservas(),
            clientes: clientes,
            financeiro: dadosFinanceiros,
            limpeza: dadosLimpeza,
            configuracao: configuracaoAtual
        };
        
        try {
            localStorage.setItem('backupAntesMudancaConfig', JSON.stringify(backupAntes));
        } catch (e) {
            console.error('Erro ao criar backup:', e);
        }
        
        // Criar nova configura√ß√£o
        const novaConfig = {
            dataInicio: dataInicio,
            dataFim: dataFim,
            unidades: unidades
        };
        
        // Salvar configura√ß√£o
        salvarConfiguracao(novaConfig);
        
        // Recriar calend√°rio
        meses = gerarMesesDaConfiguracao(novaConfig);
        unidades = novaConfig.unidades;
        mesAtualIndex = 0;
        
        // Inicializar configura√ß√£o de temporada
        const config = carregarConfiguracao();
        meses = gerarMesesDaConfiguracao(config);
        unidades = config.unidades;
        
        criarCalendario();
        carregarDadosLocais();
        aplicarFiltros();
        
        // Fechar modal
        const modal = document.getElementById('modalConfigurarTemporada');
        if (modal) modal.style.display = 'none';
        
        showNotification('Configura√ß√µes aplicadas com sucesso! O calend√°rio foi atualizado.', 'success');
    }
    
    // Formatar data para exibi√ß√£o
    function formatarData(dataISO) {
        const [ano, mes, dia] = dataISO.split('-');
        return `${dia}/${mes}/${ano}`;
    }


    // CONFIGURA√á√ïES
    let unidades = ["UN01", "UN02", "UN03"]; // Ser√° sobrescrito pela configura√ß√£o
    let meses = [
        { nome: "Novembro", dias: 30, ano: 2025 },
        { nome: "Dezembro", dias: 31, ano: 2025 },
        { nome: "Janeiro", dias: 31, ano: 2026 },
        { nome: "Fevereiro", dias: 28, ano: 2026 },
        { nome: "Mar√ßo", dias: 31, ano: 2026 },
        { nome: "Abril", dias: 30, ano: 2026 },
        { nome: "Maio", dias: 31, ano: 2026 }
    ]; // Ser√° sobrescrito pela configura√ß√£o

    // *** FUN√á√ÉO PARA CALCULAR O M√äS ATUAL ***
    function calcularMesAtual() {
        const hoje = new Date();
        const mesAtual = hoje.getMonth(); // 0-11
        const anoAtual = hoje.getFullYear();
        
        // Encontrar o √≠ndice do m√™s atual na lista de meses
        for (let i = 0; i < meses.length; i++) {
            const mesConfig = meses[i];
            const mesNumero = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"].indexOf(mesConfig.nome);
            
            if (mesNumero === mesAtual && mesConfig.ano === anoAtual) {
                return i;
            }
        }
        
        // Se n√£o encontrar o m√™s atual, retorna o primeiro m√™s
        return 0;
    }

    // --- FUN√á√ïES ---

    // *** FUN√á√ÉO DO MENU HAMB√öRGUER ***
    function toggleMenu() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('overlay');
        if (sidebar) sidebar.classList.toggle('ativo');
        if (overlay) overlay.classList.toggle('ativo');
    }

    // Fun√ß√£o auxiliar para gerar ID √∫nico de cliente (nome + whatsapp)
    function gerarIdCliente(nome, whats) {
        const nomeNorm = (nome || '').trim().toLowerCase();
        const whatsNorm = (whats || '').trim().replace(/\D/g, ''); // Remove n√£o-d√≠gitos
        return `${nomeNorm}|${whatsNorm}`;
    }



    // NOTA: O sistema usa nome+whatsapp como identificador √∫nico para VALIDA√á√ÉO de duplicados,
    // mas as buscas continuam usando nome porque:
    // 1. O dropdown de clientes usa nome como value
    // 2. As reservas armazenam o nome do cliente
    // 3. Isso mant√©m compatibilidade com dados existentes


    // NOTA: O sistema usa nome+whatsapp como identificador √∫nico para VALIDA√á√ÉO de duplicados,
    // mas as buscas continuam usando nome porque:
    // 1. O dropdown de clientes usa nome como value
    // 2. As reservas armazenam o nome do cliente
    // 3. Isso mant√©m compatibilidade com dados existentes

    function showNotification(message, type = "info") {
        const notificationDiv = document.createElement("div");
        notificationDiv.textContent = message;
        notificationDiv.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 8px; color: white; z-index: 3000; font-family: 'Poppins', sans-serif; background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};`;
        document.body.appendChild(notificationDiv);
        setTimeout(() => notificationDiv.remove(), 3000);
    }

    function atualizarVisualizacaoMes() {
        const mesInfo = meses[mesAtualIndex];
        const mesAtualDisplay = document.getElementById('mesAtualDisplay');
        const mesAnteriorBtn = document.getElementById('mesAnteriorBtn');
        const mesProximoBtn = document.getElementById('mesProximoBtn');
        if (!mesAtualDisplay || !mesAnteriorBtn || !mesProximoBtn || !mesInfo) return;
        mesAtualDisplay.textContent = `${mesInfo.nome} ${mesInfo.ano}`;
        document.querySelectorAll('.unidade-coluna .mes').forEach(mesDiv => {
            if (mesDiv && mesDiv.dataset) {
                 mesDiv.style.display = mesDiv.dataset.mes === mesInfo.nome ? 'block' : 'none';
            }
        });
        mesAnteriorBtn.disabled = mesAtualIndex === 0;
        mesProximoBtn.disabled = mesAtualIndex === meses.length - 1;
    }
    
    function criarCalendario() {
        const container = document.getElementById("calendario-container");
        if (!container) return; 
        container.innerHTML = '';
        unidades.forEach(unidade => {
            const uDiv = document.createElement("div");
            uDiv.classList.add("unidade-coluna");
            uDiv.innerHTML = `<h2>${unidade}</h2>`;
            meses.forEach(mes => {
                const mDiv = document.createElement("div");
                mDiv.classList.add("mes");
                mDiv.dataset.mes = mes.nome;
                const dCont = document.createElement("div");
                dCont.classList.add("dias");
                for (let i = 1; i <= mes.dias; i++) {
                    const dDiv = document.createElement("div");
                    dDiv.classList.add("dia");
                    dDiv.innerHTML = `<strong>${i}</strong>`;
                    Object.assign(dDiv.dataset, { dia: i, mes: mes.nome, ano: mes.ano, unidade: unidade });
                    dCont.appendChild(dDiv);
                }
                mDiv.appendChild(dCont);
                uDiv.appendChild(mDiv);
            });
            container.appendChild(uDiv);
        });
        atualizarVisualizacaoMes(); 
    }

    function aplicarFiltros() {
        const clienteSelect = document.getElementById("clienteSelect");
        if (!clienteSelect) return;
        const clienteFiltro = clienteSelect.value;
        document.querySelectorAll('.dia').forEach(diaDiv => {
            const { entrada, saida, hospedado } = diaDiv.dataset;
            const clientesDoDia = [entrada, saida, hospedado].filter(Boolean);
            let matchCliente = !clienteFiltro || clientesDoDia.includes(clienteFiltro);
            if (matchCliente) {
                diaDiv.classList.remove('filtered-out');
                if (clienteFiltro) diaDiv.classList.add("filtered-in");
                else diaDiv.classList.remove("filtered-in");
            } else {
                diaDiv.classList.add('filtered-out');
                diaDiv.classList.remove('filtered-in');
            }
        });
    }
    
    function abrirModalCliente(modo, cliente = null) {
        const formCliente = document.getElementById('formCliente');
        const modalCliente = document.getElementById('modalCliente');
        if (!formCliente || !modalCliente) return;
        formCliente.reset();
        const modalClienteTitulo = document.getElementById('modalClienteTitulo');
        const salvarClienteBtn = document.getElementById('salvarClienteBtn');
        const clienteOriginalNomeInput = document.getElementById('clienteOriginalNomeInput');
        const clienteNomeInput = document.getElementById('clienteNomeInput');
        const clienteWhatsInput = document.getElementById('clienteWhatsInput');
        const clientePaisInput = document.getElementById('clientePaisInput');
        const clienteTempoInput = document.getElementById('clienteTempoInput');
        const clienteUnidadeInput = document.getElementById('clienteUnidadeInput');
        const clienteStatusInput = document.getElementById('clienteStatusInput');
        
        if (modo === 'editar' && cliente) {
            modalClienteTitulo.textContent = 'Editar Cliente';
            salvarClienteBtn.textContent = 'Salvar Altera√ß√µes';
            clienteOriginalNomeInput.value = cliente.nome;
            clienteNomeInput.value = cliente.nome;
            clienteWhatsInput.value = cliente.whats || '';
            clientePaisInput.value = cliente.pais || '';
            clienteTempoInput.value = cliente.tempo || '';
            clienteUnidadeInput.value = cliente.unidade || '';
            clienteStatusInput.value = cliente.status || '';
        } else {
            modalClienteTitulo.textContent = 'Adicionar Novo Cliente';
            salvarClienteBtn.textContent = 'Adicionar Cliente';
            clienteOriginalNomeInput.value = '';
        }
        modalCliente.style.display = 'flex';
    }

    function handleFormClienteSubmit(event) {
        event.preventDefault();
        const nome = document.getElementById('clienteNomeInput').value.trim();
        if (!nome) { showNotification("O nome do cliente √© obrigat√≥rio.", "error"); return; }
        const nomeOriginal = document.getElementById('clienteOriginalNomeInput').value;
        const whatsAtual = document.getElementById('clienteWhatsInput').value.trim();
        const idAtual = gerarIdCliente(nome, whatsAtual);
        const whatsOriginal = nomeOriginal ? clientes.find(c => c.nome === nomeOriginal)?.whats : null;
        const idOriginal = gerarIdCliente(nomeOriginal, whatsOriginal);
        
        if (clientes.some(c => gerarIdCliente(c.nome, c.whats) === idAtual && idAtual !== idOriginal)) { 
            showNotification("J√° existe um cliente com este nome e WhatsApp.", "error"); 
            return; 
        }
        const dadosCliente = {
            nome: nome,
            whats: document.getElementById('clienteWhatsInput').value.trim(),
            pais: document.getElementById('clientePaisInput').value.trim(),
            tempo: document.getElementById('clienteTempoInput').value.trim(),
            unidade: document.getElementById('clienteUnidadeInput').value.trim(),
            status: document.getElementById('clienteStatusInput').value.trim()
        };
        if (nomeOriginal) {
            const index = clientes.findIndex(c => c.nome === nomeOriginal);
            if (index > -1) clientes[index] = dadosCliente;
        } else {
            clientes.push(dadosCliente);
        }
        preencherListaClientes(clientes);
        const clienteSelect = document.getElementById("clienteSelect");
        if(clienteSelect) clienteSelect.value = dadosCliente.nome;
        clienteSelecionado = dadosCliente.nome;
        
        const editarClienteBtn = document.getElementById('editarClienteBtn');
        const removerClienteBtn = document.getElementById('removerClienteBtn');
        const gerenciarFinanceiroBtn = document.getElementById('gerenciarFinanceiroBtn');
        if(editarClienteBtn) editarClienteBtn.disabled = false;
        if(removerClienteBtn) removerClienteBtn.disabled = false;
        if(gerenciarFinanceiroBtn) gerenciarFinanceiroBtn.disabled = false;
        
        aplicarFiltros();
        salvarDadosLocalmente();
        const modalCliente = document.getElementById('modalCliente');
        if(modalCliente) modalCliente.style.display = 'none';
    }

    function preencherListaClientes(lista) {
        const clienteSelect = document.getElementById("clienteSelect");
        const filtroResvCheckbox = document.getElementById("filtroResvCheckbox");
        if (!clienteSelect || !filtroResvCheckbox) return;

        const valorAnterior = clienteSelect.value;
        clienteSelect.innerHTML = "<option value=\"\">-- Todos os Clientes --</option>";
        let listaFiltrada = filtroResvCheckbox.checked ? lista.filter(c => c.status && c.status.trim().toUpperCase() === 'RESV') : lista;
        listaFiltrada.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(c => {
            const option = document.createElement("option");
            option.value = c.nome;
            option.textContent = `${c.nome} (${c.whats || 's/n'})`;
            clienteSelect.appendChild(option);
        });
        if ([...clienteSelect.options].some(opt => opt.value === valorAnterior)) {
            clienteSelect.value = valorAnterior;
        }
    }

    function coletarDadosDeReservas() {
        const reservas = [];
        document.querySelectorAll('.dia').forEach(dia => {
            const { entrada, saida, hospedado, unidade, mes, ano, dia: diaNum } = dia.dataset;
            if (entrada || saida || hospedado) {
                reservas.push({ unidade, mes, ano, dia: diaNum, entrada: entrada || null, saida: saida || null, hospedado: hospedado || null });
            }
        });
        return reservas;
    }
    
    function baixarArquivo(conteudo, nomeArquivo, tipo = 'text/plain') {
        try {
            const blob = new Blob([conteudo], { type: tipo });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error("Erro ao baixar arquivo:", error);
            showNotification("Ocorreu um erro ao tentar gerar o arquivo.", "error");
        }
    }

    function salvarDadosLocalmente() {
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY_RESERVAS, JSON.stringify(coletarDadosDeReservas()));
            localStorage.setItem(LOCAL_STORAGE_KEY_CLIENTES, JSON.stringify(clientes));
            localStorage.setItem(LOCAL_STORAGE_KEY_FINANCEIRO, JSON.stringify(dadosFinanceiros));
            // Salva dados de limpeza COM a flag 'editada' para persist√™ncia
            localStorage.setItem(LOCAL_STORAGE_KEY_LIMPEZA, JSON.stringify(dadosLimpeza));
            showNotification("Progresso salvo localmente!", "success");
        } catch (error) {
            console.error("Erro ao salvar dados localmente:", error);
            showNotification("Erro ao salvar dados localmente.", "error");
        }
    }

    function carregarDadosLocais() {
        const clientesSalvos = localStorage.getItem(LOCAL_STORAGE_KEY_CLIENTES);
        if (clientesSalvos) { clientes = JSON.parse(clientesSalvos); preencherListaClientes(clientes); }
        const reservasSalvas = localStorage.getItem(LOCAL_STORAGE_KEY_RESERVAS);
        if (reservasSalvas) {
            JSON.parse(reservasSalvas).forEach(reserva => {
                const diaDiv = document.querySelector(`.dia[data-unidade="${reserva.unidade}"][data-mes="${reserva.mes}"][data-dia="${reserva.dia}"]`);
                if (diaDiv) {
                    diaDiv.dataset.entrada = reserva.entrada || "";
                    diaDiv.dataset.saida = reserva.saida || "";
                    diaDiv.dataset.hospedado = reserva.hospedado || "";
                    atualizarVisual(diaDiv);
                }
            });
        }
        const financasSalvas = localStorage.getItem(LOCAL_STORAGE_KEY_FINANCEIRO);
        if (financasSalvas) {
            dadosFinanceiros = JSON.parse(financasSalvas);
            // Remove registros financeiros inv√°lidos (sem idReserva)
            dadosFinanceiros = dadosFinanceiros.filter(f => f.idReserva && f.idReserva.trim() !== '');
        }
        
        const limpezaSalva = localStorage.getItem(LOCAL_STORAGE_KEY_LIMPEZA);
        if (limpezaSalva) {
            dadosLimpeza = JSON.parse(limpezaSalva);
            // Remove registros inv√°lidos (datas NaN ou tipos incorretos)
            dadosLimpeza = dadosLimpeza.filter(l => {
                return l.data && l.data !== 'NaN-NaN-NaN' && !l.data.includes('NaN') && l.tipo !== 'Limpeza de Entrada';
            });
        }

         const autoBackupToggle = document.getElementById('autoBackupToggle');
         const autoBackupPref = localStorage.getItem('autoBackupEnabled');
        if (autoBackupPref === 'true' && autoBackupToggle) {
            autoBackupToggle.checked = true;
        }
    }
    
    function sincronizarLimpezasComSaidas() {
        // Percorre todos os dias do calend√°rio e cria tarefas de limpeza para sa√≠das que n√£o t√™m
        document.querySelectorAll('.dia').forEach(diaDiv => {
            const { saida, unidade, ano, mes, dia } = diaDiv.dataset;
            if (saida) {
                const dataFormatada = formatarDataParaID(ano, mes, dia);
                const idLimpeza = `${unidade}-${dataFormatada}`;
                // Verifica se j√° existe uma tarefa de limpeza para esta sa√≠da
                const tarefaExistente = dadosLimpeza.find(l => l.id === idLimpeza && l.tipo === "Faxina de Sa√≠da");
                if (!tarefaExistente) {
                    const novaTarefa = {
                        id: idLimpeza,
                        unidade: unidade,
                        data: dataFormatada,
                        tipo: "Faxina de Sa√≠da",
                        status: "Pendente",
                        editada: false // Novas tarefas n√£o s√£o editadas por padr√£o
                    };
                    dadosLimpeza.push(novaTarefa);
                }
                // Se j√° existe, preserva a flag 'editada' existente
            }
        });
        // Salva ap√≥s sincronizar para persistir as mudan√ßas
        salvarDadosLocalmente();
    }
    
    function limparDadosLocais() {
        if (confirm("Voc√™ tem certeza que deseja apagar TODOS os dados (reservas, clientes, finan√ßas)? Esta a√ß√£o n√£o pode ser desfeita.")) {
            localStorage.clear();
            location.reload();
        }
    }
    
    function importarListaClientes(texto) {
        try {
            const linhas = texto.split("\n").filter(l => l.trim());
            const novosClientes = linhas.map(linha => {
                const [nome, whats, pais, tempo, unidade, status] = linha.split("-");
                return { nome: nome.trim(), whats, pais, tempo, unidade, status };
            });
            let importados = 0;
            let duplicados = 0;
            novosClientes.forEach(nc => {
                const idNovo = gerarIdCliente(nc.nome, nc.whats);
                if (!clientes.some(c => gerarIdCliente(c.nome, c.whats) === idNovo)) {
                    clientes.push(nc);
                    importados++;
                } else {
                    duplicados++;
                }
            });
            preencherListaClientes(clientes);
            salvarDadosLocalmente(); // Sempre salva ap√≥s importar clientes
            showNotification(`${importados} cliente(s) importado(s) com sucesso! ${duplicados > 0 ? duplicados + " duplicado(s) ignorado(s)." : ""}`, "success");
        } catch (err) {
            showNotification("Erro ao importar clientes.", "error");
        }
    }

    // --- NOVAS FUN√á√ïES DE IMPORT/EXPORT ---
    function exportarBackupCompleto() {
        const backupData = {
            clientes: clientes,
            reservas: coletarDadosDeReservas(),
            financeiro: dadosFinanceiros,
            limpeza: dadosLimpeza
        };
        const conteudo = JSON.stringify(backupData, null, 2);
        baixarArquivo(conteudo, 'backup_completo_reservas.json', 'application/json');
    }

    function importarBackupCompleto(jsonString) {
        try {
            const backupData = JSON.parse(jsonString);
            if (!backupData || typeof backupData !== 'object') throw new Error("Arquivo JSON inv√°lido.");

            if (backupData.clientes && Array.isArray(backupData.clientes)) {
                clientes = backupData.clientes;
                preencherListaClientes(clientes);
            } else {
                clientes = []; 
                preencherListaClientes(clientes);
            }

            document.querySelectorAll('.dia').forEach(dia => {
                dia.dataset.entrada = "";
                dia.dataset.saida = "";
                dia.dataset.hospedado = "";
                atualizarVisual(dia);
            });

            if (backupData.reservas && Array.isArray(backupData.reservas)) {
                backupData.reservas.forEach(reserva => {
                    const diaDiv = document.querySelector(`.dia[data-unidade="${reserva.unidade}"][data-mes="${reserva.mes}"][data-dia="${reserva.dia}"]`);
                    if(diaDiv){
                        Object.assign(diaDiv.dataset, { entrada: reserva.entrada || "", saida: reserva.saida || "", hospedado: reserva.hospedado || "" });
                        atualizarVisual(diaDiv);
                    }
                });
            }

            if (backupData.financeiro && Array.isArray(backupData.financeiro)) {
                dadosFinanceiros = backupData.financeiro;
            } else {
                dadosFinanceiros = []; 
            }
            
            if (backupData.limpeza && Array.isArray(backupData.limpeza)) {
                dadosLimpeza = backupData.limpeza;
            } else {
                dadosLimpeza = [];
            }

            sincronizarLimpezasComSaidas(); // Sincroniza limpezas ap√≥s importar
            salvarDadosLocalmente(); 
            aplicarFiltros();
            showNotification("Backup completo importado com sucesso!", "success");

        } catch(err) {
            console.error("Erro ao importar backup:", err);
            showNotification("Erro ao importar backup completo. Verifique o arquivo JSON.", "error");
        }
    }
    
    function exportarFinanceiroJSON() {
        if (dadosFinanceiros.length === 0) return showNotification("Nenhum dado financeiro para exportar.", "info");
        const conteudo = JSON.stringify(dadosFinanceiros, null, 2);
        baixarArquivo(conteudo, 'financeiro_exportado.json', 'application/json');
    }
    // ------------------------------------
    
    function exportarListaClientes() {
        if (clientes.length === 0) return showNotification("Nenhum cliente para exportar.", "info");
        const conteudo = clientes.map(c => `${c.nome}-${c.whats || ''}-${c.pais || ''}-${c.tempo || ''}-${c.unidade || ''}-${c.status || ''}`).join('\n');
        baixarArquivo(conteudo, 'clientes_exportados.txt');
    }

    function exportarReservasTXT() {
        const dados = coletarDadosDeReservas();
        if (dados.length === 0) return showNotification("Nenhuma reserva para exportar.", "info");
        let conteudo = "UNIDADE;DATA;TIPO;CLIENTE\n";
        dados.forEach(r => {
            const data = `${r.ano}-${String(meses.findIndex(m => m.nome === r.mes) + 1).padStart(2, '0')}-${String(r.dia).padStart(2, '0')}`;
            if (r.hospedado) conteudo += `${r.unidade};${data};HOSPEDADO;${r.hospedado}\n`;
            if (r.entrada) conteudo += `${r.unidade};${data};ENTRADA;${r.entrada}\n`;
            if (r.saida) conteudo += `${r.unidade};${data};SAIDA;${r.saida}\n`;
        });
        baixarArquivo(conteudo, 'reservas_exportadas.txt');
    }

    function atualizarVisual(dia) {
        if (!dia || !dia.dataset) return; 
        const { dia: d, entrada, saida, hospedado } = dia.dataset;
        dia.className = "dia"; 
        let content = `<strong>${d}</strong>`;
        const getInfo = (cliNome) => {
            const cli = clientes.find(c => c.nome === cliNome);
            return cli ? `${cli.nome.slice(0, 3).toUpperCase()}-${cli.whats ? cli.whats.slice(-4) : 'S/N'}` : '';
        };
        if (hospedado) { dia.classList.add("hospedado"); content = `<strong>${d} <i class="bi bi-check-circle-fill icon-hospedado"></i></strong><div>${getInfo(hospedado)}-H</div>`; } 
        else if (entrada && saida) { dia.classList.add("dupla"); content = `<strong>${d} <i class="bi bi-arrow-repeat icon-troca"></i></strong><div><i class="bi bi-box-arrow-left icon-saida"></i> ${getInfo(saida)}-S</div><div><i class="bi bi-box-arrow-in-right icon-entrada"></i> ${getInfo(entrada)}-E</div>`; } 
        else if (entrada) { dia.classList.add("entrada"); content = `<strong>${d} <i class="bi bi-box-arrow-in-right icon-entrada"></i></strong><div>${getInfo(entrada)}-E</div>`; } 
        else if (saida) { dia.classList.add("saida"); content = `<strong>${d} <i class="bi bi-box-arrow-left icon-saida"></i></strong><div>${getInfo(saida)}-S</div>`; }
        dia.innerHTML = content;
        if (segurancaAtivada) dia.classList.add('seguranca-ativada');
    }

    // --- IN√çCIO: M√ìDULO DE LIMPEZA ---

    function formatarDataParaID(ano, nomeMes, dia) {
        // Mapeia o nome do m√™s para o n√∫mero real do calend√°rio
        const mapeamentoMeses = {
            "Janeiro": 1, "Fevereiro": 2, "Mar√ßo": 3, "Abril": 4,
            "Maio": 5, "Junho": 6, "Julho": 7, "Agosto": 8,
            "Setembro": 9, "Outubro": 10, "Novembro": 11, "Dezembro": 12
        };
        
        const mesNumero = mapeamentoMeses[nomeMes];
        const mesFormatado = String(mesNumero).padStart(2, '0');
        const diaFormatado = String(dia).padStart(2, '0');
        return `${ano}-${mesFormatado}-${diaFormatado}`;
    }

    // *** IN√çCIO: MODIFICA√á√ÉO (FEATURE 2) - Fun√ß√£o 'agendarLimpezaSaida' ***
    function agendarLimpezaSaida(diaDiv) {
        const { unidade, ano, mes, dia } = diaDiv.dataset;
        const dataFormatada = formatarDataParaID(ano, mes, dia);
        const idLimpeza = `${unidade}-${dataFormatada}`;

        if (dadosLimpeza.some(l => l.id === idLimpeza && l.tipo === "Faxina de Sa√≠da")) return;

        // L√≥gica para detectar "edi√ß√£o" (remo√ß√£o recente + adi√ß√£o)
        let foiEditada = false;
        if (ultimaAcaoLimpeza.acao === 'removida' && ultimaAcaoLimpeza.unidade === unidade) {
            foiEditada = true;
            ultimaAcaoLimpeza = { acao: null, data: null, unidade: null }; // Reseta a flag
        }

        const novaTarefa = {
            id: idLimpeza,
            unidade: unidade,
            data: dataFormatada,
            tipo: "Faxina de Sa√≠da",
            status: "Pendente",
            editada: foiEditada // Adiciona a flag transit√≥ria
        };
        dadosLimpeza.push(novaTarefa);
        salvarDadosLocalmente(); // Sempre salva ap√≥s agendar limpeza
    }
    // *** FIM: MODIFICA√á√ÉO (FEATURE 2) ***

    // *** IN√çCIO: MODIFICA√á√ÉO (FEATURE 2) - Fun√ß√£o 'removerLimpezaAgendada' ***
    function removerLimpezaAgendada(diaDiv) {
        const { unidade, ano, mes, dia } = diaDiv.dataset;
        const dataFormatada = formatarDataParaID(ano, mes, dia);
        const idLimpeza = `${unidade}-${dataFormatada}`;

        // Rastreia a remo√ß√£o para a Feature 2
        const tarefaRemovida = dadosLimpeza.find(l => l.id === idLimpeza && l.tipo === "Faxina de Sa√≠da");
        if (tarefaRemovida) {
            ultimaAcaoLimpeza = { acao: 'removida', data: tarefaRemovida.data, unidade: tarefaRemovida.unidade };
        }

        dadosLimpeza = dadosLimpeza.filter(l => !(l.id === idLimpeza && l.tipo === "Faxina de Sa√≠da"));
        salvarDadosLocalmente(); // Sempre salva ap√≥s remover limpeza
    }
    // *** FIM: MODIFICA√á√ÉO (FEATURE 2) ***

    // *** IN√çCIO: MODIFICA√á√ÉO (FEATURE 1 & 2) - Fun√ß√£o 'renderizarControleLimpeza' ***
    function renderizarControleLimpeza() {
        const tabelaBody = document.querySelector("#tabelaLimpeza tbody");
        if (!tabelaBody) return;
        tabelaBody.innerHTML = '';

        // FEATURE 1: Ordena por data (da mais pr√≥xima para a mais distante)
        dadosLimpeza.sort((a, b) => new Date(a.data) - new Date(b.data));

        if (dadosLimpeza.length === 0) {
            tabelaBody.innerHTML = '<tr><td colspan="4">Nenhuma tarefa de limpeza agendada.</td></tr>';
            return;
        }

        dadosLimpeza.forEach(tarefa => {
            const tr = document.createElement('tr');
            const statusClass = tarefa.status === 'Pendente' ? 'status-pendente' : 'status-concluida';
            
            // Adiciona classe especial para limpezas editadas
            if (tarefa.editada) {
                tr.classList.add('limpeza-editada');
            }
            
            let statusHTML = `<span class="${statusClass}">${tarefa.status}</span>`;
            if (tarefa.status === 'Pendente') {
                statusHTML = `<button data-id="${tarefa.id}">Marcar Conclu√≠da</button>`;
            }

            // FEATURE 2: Adiciona marca√ß√£o visual para tarefas "editadas"
            const charEditada = tarefa.editada ? '<i class="bi bi-exclamation-triangle-fill icone-editada"></i> ' : '';

            tr.innerHTML = `
                <td>${tarefa.data.split('-').reverse().join('/')}</td>
                <td>${tarefa.unidade}</td>
                <td>${charEditada}${tarefa.tipo}</td>
                <td>${statusHTML}</td>
            `;
            tabelaBody.appendChild(tr);
        });
    }
    // *** FIM: MODIFICA√á√ÉO (FEATURE 1 & 2) ***

    function handleTabelaLimpezaClick(event) {
        const target = event.target;
        if (target.tagName === 'BUTTON' && target.dataset.id) {
            const tarefaId = target.dataset.id;
            const tarefa = dadosLimpeza.find(l => l.id === tarefaId);
            if (tarefa) {
                tarefa.status = 'Conclu√≠da';
                salvarDadosLocalmente();
                renderizarControleLimpeza();
            }
        }
    }
    
    // --- FIM: M√ìDULO DE LIMPEZA ---
    
    // --- M√ìDULO FINANCEIRO ---
    function salvarDadosFinanceiros() {
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY_FINANCEIRO, JSON.stringify(dadosFinanceiros));
        } catch (error) { showNotification("Erro ao salvar dados financeiros.", "error"); }
    }

    function encontrarReservasDoCliente(clienteNome) {
        const todasReservas = coletarDadosDeReservas().filter(r => r.entrada === clienteNome || r.saida === clienteNome || r.hospedado === clienteNome);
        const reservasPorUnidade = {};
        todasReservas.forEach(reserva => {
            if (!reservasPorUnidade[reserva.unidade]) reservasPorUnidade[reserva.unidade] = [];
            const getJsMonth = (nomeMes) => ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"].indexOf(nomeMes);
            reservasPorUnidade[reserva.unidade].push({ ...reserva, dataObj: new Date(reserva.ano, getJsMonth(reserva.mes), reserva.dia) });
        });
        const blocosDeReserva = [];
        for (const unidade in reservasPorUnidade) {
            const reservasDoCliente = reservasPorUnidade[unidade].sort((a, b) => a.dataObj - b.dataObj);
            if (reservasDoCliente.length === 0) continue;
            let blocoAtual = { inicio: reservasDoCliente[0], fim: reservasDoCliente[0], unidade: unidade, cliente: clienteNome };
            for (let i = 1; i < reservasDoCliente.length; i++) {
                if ((reservasDoCliente[i].dataObj - blocoAtual.fim.dataObj) / (1000 * 3600 * 24) <= 1.5) { // Toler√¢ncia para fuso hor√°rio
                    blocoAtual.fim = reservasDoCliente[i];
                } else {
                    blocosDeReserva.push(blocoAtual);
                    blocoAtual = { inicio: reservasDoCliente[i], fim: reservasDoCliente[i], unidade: unidade, cliente: clienteNome };
                }
            }
            blocosDeReserva.push(blocoAtual);
        }
        return blocosDeReserva;
    }
    
    function abrirModalFinanceiro(reserva) {
        const formFinanceiro = document.getElementById('formFinanceiro');
        const infoReservaFinanceiro = document.getElementById('infoReservaFinanceiro');
        const reservaIdInput = document.getElementById('reservaIdInput');
        const valorDiariaInput = document.getElementById('valorDiariaInput');
        const valorSinalInput = document.getElementById('valorSinalInput');
        const dataPagSinalInput = document.getElementById('dataPagSinalInput');
        const formaPagSinalInput = document.getElementById('formaPagSinalInput');
        const listaReservasFinanceiro = document.getElementById('listaReservasFinanceiro');
        const modalFinanceiro = document.getElementById('modalFinanceiro');
        
        if (!formFinanceiro) return;
        formFinanceiro.reset();

        const f = (d) => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
        if(infoReservaFinanceiro) infoReservaFinanceiro.innerHTML = `<strong>Cliente:</strong> ${reserva.cliente}<br><strong>Unidade:</strong> ${reserva.unidade}<br><strong>Per√≠odo:</strong> ${f(reserva.inicio.dataObj)} a ${f(reserva.fim.dataObj)}`;
        
        const idReservaAtual = `${reserva.unidade}-${reserva.cliente}-${reserva.inicio.dataObj.toISOString().split('T')[0]}`;
        if(reservaIdInput) reservaIdInput.value = idReservaAtual;

        let dadosExistentes = dadosFinanceiros.find(d => d.idReserva && d.idReserva === idReservaAtual);
        if (!dadosExistentes) {
            const dadoOrfaoIndex = dadosFinanceiros.findIndex(d => d.idReserva && d.idReserva.startsWith(`${reserva.unidade}-${reserva.cliente}-`));
            if (dadoOrfaoIndex > -1) {
                if (confirm("Dados financeiros de uma reserva antiga foram encontrados. Deseja mov√™-los para a reserva atual?")) {
                    dadosFinanceiros[dadoOrfaoIndex].idReserva = idReservaAtual;
                    dadosExistentes = dadosFinanceiros[dadoOrfaoIndex];
                    salvarDadosFinanceiros();
                    showNotification("Dados migrados!", "success");
                }
            }
        }
        if (dadosExistentes) { 
            if(valorDiariaInput) valorDiariaInput.value = dadosExistentes.valorDiaria;
            if(valorSinalInput) valorSinalInput.value = dadosExistentes.valorSinal;
            if(dataPagSinalInput) dataPagSinalInput.value = dadosExistentes.dataPagSinal;
            if(formaPagSinalInput) formaPagSinalInput.value = dadosExistentes.formaPagSinal;
        }
        
        if(listaReservasFinanceiro) listaReservasFinanceiro.style.display = 'none';
        if(infoReservaFinanceiro) infoReservaFinanceiro.style.display = 'block';
        formFinanceiro.style.display = 'block';
        if(modalFinanceiro) modalFinanceiro.style.display = 'flex';
    }

    function handleFormFinanceiroSubmit(event) {
        event.preventDefault();
        const reservaIdInput = document.getElementById('reservaIdInput');
        const valorDiariaInput = document.getElementById('valorDiariaInput');
        const valorSinalInput = document.getElementById('valorSinalInput');
        const dataPagSinalInput = document.getElementById('dataPagSinalInput');
        const formaPagSinalInput = document.getElementById('formaPagSinalInput');
        const modalFinanceiro = document.getElementById('modalFinanceiro');

        if (!reservaIdInput) return;
        const idReserva = reservaIdInput.value;
        const dados = { idReserva, valorDiaria: parseFloat(valorDiariaInput.value) || 0, valorSinal: parseFloat(valorSinalInput.value) || 0, dataPagSinal: dataPagSinalInput.value, formaPagSinal: formaPagSinalInput.value };
        const index = dadosFinanceiros.findIndex(d => d.idReserva === idReserva);
        if (index > -1) { dadosFinanceiros[index] = { ...dadosFinanceiros[index], ...dados }; } 
        else { dadosFinanceiros.push(dados); }
        salvarDadosFinanceiros();
        showNotification("Dados financeiros salvos!", "success");
        if(modalFinanceiro) modalFinanceiro.style.display = 'none';
    }

    // *** IN√çCIO: CORRE√á√ÉO DO ERRO (Linha 1409) ***
    function gerarRelatorioFinanceiro() {
        const container = document.getElementById('relatorioFinanceiroConteudo');
        if (!container) return;
        container.innerHTML = '';
        
        // Verifica se h√° reservas sem dados financeiros
        // Coleta TODAS as reservas do calend√°rio, n√£o apenas dos clientes cadastrados
        const reservasDoCalendario = coletarDadosDeReservas();
        const nomesDeClientes = [...new Set(reservasDoCalendario.flatMap(r => [r.entrada, r.saida, r.hospedado].filter(Boolean)))];
        const todosOsBlocos = nomesDeClientes.flatMap(nome => encontrarReservasDoCliente(nome));
        const reservasSemFinanceiro = todosOsBlocos.filter(bloco => {
            const idReserva = `${bloco.unidade}-${bloco.cliente}-${bloco.inicio.dataObj.toISOString().split('T')[0]}`;
            return !dadosFinanceiros.some(d => d.idReserva === idReserva);
        });
        
        if (reservasSemFinanceiro.length > 0) {
            const avisoHTML = `
                <div style="background-color: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #856404; margin: 0 0 10px 0;">
                        ‚ö†Ô∏è ATEN√á√ÉO: ${reservasSemFinanceiro.length} reserva(s) sem dados financeiros!
                    </h4>
                    <p style="margin: 0; color: #856404;">
                        As seguintes reservas n√£o possuem dados financeiros cadastrados:
                    </p>
                    <ul style="margin: 10px 0 0 20px; color: #856404;">
                        ${reservasSemFinanceiro.slice(0, 5).map(b => {
                            const f = (dt) => `${String(dt.getDate()).padStart(2, '0')}/${String(dt.getMonth() + 1).padStart(2, '0')}`;
                            return `<li><strong>${b.cliente}</strong> - ${b.unidade} (${f(b.inicio.dataObj)} a ${f(b.fim.dataObj)})</li>`;
                        }).join('')}
                        ${reservasSemFinanceiro.length > 5 ? `<li><em>... e mais ${reservasSemFinanceiro.length - 5} reserva(s)</em></li>` : ''}
                    </ul>
                    <p style="margin: 10px 0 0 0; color: #856404; font-weight: bold;">
                        üìå Recomenda-se preencher os dados financeiros de todas as reservas.
                    </p>
                </div>
            `;
            container.innerHTML = avisoHTML;
        }
        
        if (dadosFinanceiros.length === 0) { 
            container.innerHTML += '<p>Nenhum dado financeiro registrado.</p>'; 
            return; 
        }
        const totais = { geral: { valorTotal: 0, sinal: 0, restante: 0 }, unidades: {} };
        unidades.forEach(u => totais.unidades[u] = { valorTotal: 0, sinal: 0, restante: 0 });
        let tableHTML = `<table class="relatorio-financeiro"><thead><tr><th>Cliente</th><th>Unidade</th><th>Per√≠odo</th><th>Noites</th><th>Vl. Di√°ria</th><th>Vl. Total</th><th>Vl. Sinal</th><th>Restante</th><th>Status Sinal</th></tr></thead><tbody>`;
        // todosOsBlocos j√° foi definido acima para verificar reservas sem financeiro
        
        dadosFinanceiros.forEach(dado => {
            
            // *** IN√çCIO DA CORRE√á√ÉO ***
            // Verifica se 'dado' existe e se 'idReserva' √© uma string v√°lida antes de usar 'match'
            if (!dado || typeof dado.idReserva !== 'string') {
                console.warn("Dado financeiro inv√°lido ou sem idReserva:", dado);
                return; // Pula este item do loop para evitar o erro
            }
            // *** FIM DA CORRE√á√ÉO ***

            const match = dado.idReserva.match(/^([^-]+)-(.*?)-(\d{4}-\d{2}-\d{2})$/);
            
            if (!match) {
                 // Se o idReserva existir mas n√£o bater com o formato esperado, loga e continua
                console.warn("Formato de idReserva inesperado:", dado.idReserva);
                return; 
            }

            const [, unidade, cliente, dataInicioISO] = match;
            const bloco = todosOsBlocos.find(b => b.unidade === unidade && b.cliente === cliente && b.inicio.dataObj.toISOString().split('T')[0] === dataInicioISO);
            if (bloco) {
                const noites = Math.ceil(Math.abs(bloco.fim.dataObj - bloco.inicio.dataObj) / (1000 * 3600 * 24));
                const valorTotal = dado.valorDiaria * noites;
                const restante = valorTotal - dado.valorSinal;
                if(totais.unidades[unidade]) {
                    Object.assign(totais.unidades[unidade], { valorTotal: totais.unidades[unidade].valorTotal + valorTotal, sinal: totais.unidades[unidade].sinal + dado.valorSinal, restante: totais.unidades[unidade].restante + restante });
                }
                Object.assign(totais.geral, { valorTotal: totais.geral.valorTotal + valorTotal, sinal: totais.geral.sinal + dado.valorSinal, restante: totais.geral.restante + restante });
                const f = (dt) => `${String(dt.getDate()).padStart(2, '0')}/${String(dt.getMonth() + 1).padStart(2, '0')}`;
                const statusSinal = dado.dataPagSinal ? `Pago em ${dado.dataPagSinal.split('-').reverse().join('/')} (${dado.formaPagSinal})` : 'Pendente';
                tableHTML += `<tr><td>${cliente}</td><td>${unidade}</td><td>${f(bloco.inicio.dataObj)} a ${f(bloco.fim.dataObj)}</td><td>${noites}</td><td>R$ ${dado.valorDiaria.toFixed(2)}</td><td>R$ ${valorTotal.toFixed(2)}</td><td>R$ ${dado.valorSinal.toFixed(2)}</td><td>R$ ${restante.toFixed(2)}</td><td>${statusSinal}</td></tr>`;
            } else {
                if (totais.unidades[unidade]) totais.unidades[unidade].sinal += dado.valorSinal;
                totais.geral.sinal += dado.valorSinal;
                tableHTML += `<tr style="background-color: #ffe0e0;"><td>${cliente}</td><td>${unidade}</td><td colspan="2"><strong style="color: red;">Reserva n√£o encontrada!</strong></td><td>R$ ${dado.valorDiaria.toFixed(2)}</td><td>N/A</td><td>R$ ${dado.valorSinal.toFixed(2)}</td><td>N/A</td><td>${dado.dataPagSinal ? `Pago em ${dado.dataPagSinal.split('-').reverse().join('/')} (${dado.formaPagSinal})` : 'Pendente'}</td></tr>`;
            }
        });
        tableHTML += `</tbody><tfoot>`;
        for(const unidade of unidades) {
            if(totais.unidades[unidade] && (totais.unidades[unidade].valorTotal > 0 || totais.unidades[unidade].sinal > 0)){
                tableHTML += `<tr><td colspan="5"><strong>Total ${unidade}</strong></td><td><strong>R$ ${totais.unidades[unidade].valorTotal.toFixed(2)}</strong></td><td><strong>R$ ${totais.unidades[unidade].sinal.toFixed(2)}</strong></td><td><strong>R$ ${totais.unidades[unidade].restante.toFixed(2)}</strong></td><td></td></tr>`;
            }
        }
        tableHTML += `<tr style="background-color: #e0e0e0;"><td colspan="5"><strong>TOTAL GERAL</strong></td><td><strong>R$ ${totais.geral.valorTotal.toFixed(2)}</strong></td><td><strong>R$ ${totais.geral.sinal.toFixed(2)}</strong></td><td><strong>R$ ${totais.geral.restante.toFixed(2)}</strong></td><td></td></tr>`;
        container.innerHTML = tableHTML + `</tfoot></table>`;
    }
    // *** FIM: CORRE√á√ÉO DO ERRO ***
    
    function gerarRelatorioDetalhado() {
        const relatorioConteudoTexto = document.getElementById('relatorioConteudoTexto');
        if (!relatorioConteudoTexto) return;
        relatorioConteudoTexto.innerHTML = '';
        const blocosDeReserva = [...new Set(clientes.map(c => c.nome))].flatMap(nome => encontrarReservasDoCliente(nome));
        if (blocosDeReserva.length === 0) { relatorioConteudoTexto.innerHTML = '<p>Nenhuma reserva registrada.</p>'; return; }
        const diasTotais = meses.reduce((total, mes) => total + mes.dias, 0);
        const ocupacao = analisarOcupacaoDosDias();
        const htmlResumoGeral = document.createElement('div');
        htmlResumoGeral.innerHTML = `<h3>Resumo de Ocupa√ß√£o Geral</h3>`;
        for (const unidade of unidades) {
            const diasOcupados = ocupacao[unidade] ? Object.keys(ocupacao[unidade]).length : 0;
            const porcentagemOcupacao = diasTotais > 0 ? (diasOcupados / diasTotais * 100).toFixed(2) : 0;
            htmlResumoGeral.innerHTML += `<p><strong>Unidade: ${unidade}</strong> | Ocupados: ${diasOcupados} | Livres: ${diasTotais - diasOcupados} | Taxa: ${porcentagemOcupacao}%</p>`;
        }
        relatorioConteudoTexto.appendChild(htmlResumoGeral);
        relatorioConteudoTexto.innerHTML += '<hr>';
        const relatoriosPorUnidade = {};
        blocosDeReserva.forEach(bloco => {
            if(!relatoriosPorUnidade[bloco.unidade]) relatoriosPorUnidade[bloco.unidade] = [];
            relatoriosPorUnidade[bloco.unidade].push(bloco);
        });
        for (const unidade of unidades) {
            if (relatoriosPorUnidade[unidade] && relatoriosPorUnidade[unidade].length > 0) {
                const htmlUnidade = document.createElement('div');
                htmlUnidade.innerHTML = `<h4>Reservas da Unidade ${unidade}</h4>`;
                const ul = document.createElement('ul');
                relatoriosPorUnidade[unidade].forEach(bloco => {
                    const noites = Math.ceil(Math.abs(bloco.fim.dataObj - bloco.inicio.dataObj) / (1000 * 3600 * 24));
                    const f = (d) => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}`;
                    const clienteInfo = clientes.find(c => c.nome === bloco.cliente);
                    const texto = `${bloco.cliente} (Whats: ${clienteInfo ? (clienteInfo.whats || 'N/A') : 'N/A'}): Entra (${f(bloco.inicio.dataObj)}) - Sai (${f(bloco.fim.dataObj)}) = ${noites} noites`;
                    const li = document.createElement('li');
                    li.textContent = texto;
                    ul.appendChild(li);
                });
                htmlUnidade.appendChild(ul);
                relatorioConteudoTexto.appendChild(htmlUnidade);
            }
        }
    }

    function analisarOcupacaoDosDias() {
        const ocupacao = {};
        unidades.forEach(u => ocupacao[u] = {});
        document.querySelectorAll('.dia').forEach(dia => {
            const { entrada, saida, hospedado, unidade, mes, ano, dia: diaNum } = dia.dataset;
            if (entrada || saida || hospedado) {
                const chaveData = `${ano}-${mes}-${diaNum}`;
                ocupacao[unidade][chaveData] = { entrada: !!entrada, saida: !!saida, hospedado: !!hospedado };
            }
        });
        return ocupacao;
    }

    function gerarRelatorioVisual() {
        const relatorioConteudoVisual = document.getElementById('relatorioConteudoVisual');
        if (!relatorioConteudoVisual) return;
        relatorioConteudoVisual.innerHTML = ''; 
        const ocupacao = analisarOcupacaoDosDias();
        const diasDaSemana = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
        
        unidades.forEach(unidade => { 
            const containerUnidade = document.createElement('div');
            containerUnidade.classList.add('unidade-relatorio'); 
            containerUnidade.innerHTML = `<h4>Unidade: ${unidade}</h4>`;
            
            meses.forEach(mesInfo => { 
                const containerMes = document.createElement('div');
                containerMes.classList.add('mes-relatorio'); 
                containerMes.innerHTML = `<h5>${mesInfo.nome} ${mesInfo.ano}</h5>`;
                
                const gridDias = document.createElement('div');
                gridDias.classList.add('dias-relatorio');
                
                diasDaSemana.forEach(dia => { 
                    const headerDia = document.createElement('div');
                    headerDia.classList.add('dia-relatorio', 'header');
                    headerDia.textContent = dia;
                    gridDias.appendChild(headerDia);
                });
                
                const getJsMonth = (nomeMes) => ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"].indexOf(nomeMes);
                const primeiroDia = new Date(mesInfo.ano, getJsMonth(mesInfo.nome), 1).getDay();
                
                for (let i = 0; i < primeiroDia; i++) { 
                    gridDias.appendChild(document.createElement('div')); 
                }

                for (let i = 1; i <= mesInfo.dias; i++) {
                    const diaDiv = document.createElement('div');
                    diaDiv.classList.add('dia-relatorio');
                    diaDiv.textContent = i;
                    
                    const chaveData = `${mesInfo.ano}-${mesInfo.nome}-${i}`;
                    const diaOcupacao = ocupacao[unidade] ? ocupacao[unidade][chaveData] : null;

                    if (diaOcupacao) {
                        if (diaOcupacao.entrada && diaOcupacao.saida) diaDiv.classList.add('troca');
                        else if (diaOcupacao.hospedado || diaOcupacao.entrada) diaDiv.classList.add('noite-ocupada');
                        else if (diaOcupacao.saida) diaDiv.classList.add('checkout-apenas');
                    }
                    gridDias.appendChild(diaDiv);
                }

                containerMes.appendChild(gridDias);
                containerUnidade.appendChild(containerMes);
            });
            relatorioConteudoVisual.appendChild(containerUnidade); 
        });
    }
    
    // L√ìGICA DE INTERA√á√ÉO COM O CALEND√ÅRIO
    function registrarReserva(dia) {
        if (!clienteSelecionado) return showNotification("Selecione um cliente para fazer uma reserva.", "error");
        const cliente = clientes.find(c => c.nome === clienteSelecionado);
        if (!cliente) return;
        let { entrada, saida, hospedado } = dia.dataset;

        const eraSaida = saida === cliente.nome;

        if (saida === cliente.nome && entrada && entrada !== cliente.nome) { dia.dataset.saida = ""; } 
        else if (entrada === cliente.nome && saida && saida !== cliente.nome) { dia.dataset.entrada = ""; } 
        else if (hospedado && hospedado !== cliente.nome) { return showNotification("Este dia j√° est√° ocupado por outro cliente.", "error"); } 
        else if (entrada === cliente.nome && saida === cliente.nome) { dia.dataset.entrada = ""; dia.dataset.saida = ""; dia.dataset.hospedado = ""; } 
        else if (entrada === cliente.nome && !saida) { dia.dataset.hospedado = cliente.nome; dia.dataset.entrada = ""; dia.dataset.saida = ""; } 
        else if (hospedado === cliente.nome) { 
            dia.dataset.saida = cliente.nome; 
            dia.dataset.entrada = ""; 
            dia.dataset.hospedado = ""; 
            agendarLimpezaSaida(dia);
        } 
        else if (saida === cliente.nome && !entrada) { dia.dataset.entrada = ""; dia.dataset.saida = ""; dia.dataset.hospedado = ""; } 
        else if (!entrada && !saida && !hospedado) { dia.dataset.entrada = cliente.nome; } 
        else if (entrada && entrada !== cliente.nome && !saida) { dia.dataset.saida = cliente.nome; } 
        else if (saida && saida !== cliente.nome && !entrada) { dia.dataset.entrada = cliente.nome; } 
        else if (entrada && entrada !== cliente.nome && saida && saida !== cliente.nome) { return showNotification("Este dia j√° est√° ocupado por outros clientes.", "error"); }

        const virouOutraCoisa = dia.dataset.saida !== cliente.nome;
        if (eraSaida && virouOutraCoisa) {
            removerLimpezaAgendada(dia);
        }

        atualizarVisual(dia);
        salvarDadosLocalmente(); // Sempre salva ap√≥s editar reserva
    }

    function limparDia(dia) {
        dia.dataset.entrada = "";
        dia.dataset.saida = "";
        dia.dataset.hospedado = "";
        atualizarVisual(dia);
        salvarDadosLocalmente(); // Sempre salva ap√≥s limpar dia
    }
    
    function gerenciarTooltip(event) {
        const diaDiv = event.target.closest('.dia');
        const tooltip = document.getElementById('tooltip');
        if (!tooltip || !diaDiv) { 
            // Delay para permitir mover mouse para o tooltip
            tooltipTimeout = setTimeout(hideTooltip, 200);
            return; 
        }
        
        // Cancela o timeout se voltar para a c√©lula
        clearTimeout(tooltipTimeout);
        const { entrada, saida, hospedado } = diaDiv.dataset;
        const clientesDoDia = [...new Set([entrada, saida, hospedado].filter(Boolean))];
        if (clientesDoDia.length === 0) { hideTooltip(); return; }
        let tooltipContent = '';
        clientesDoDia.forEach(nomeCliente => {
            const clienteInfo = clientes.find(c => c.nome === nomeCliente);
            if (clienteInfo) {
                // Buscar dados da reserva para o bot√£o WhatsApp
                const unidade = diaDiv.dataset.unidade;
                const dia = diaDiv.dataset.dia;
                const mes = diaDiv.dataset.mes;
                const ano = diaDiv.dataset.ano;
                
                // Encontrar entrada e sa√≠da da reserva
                let dataEntrada = null;
                let dataSaida = null;
                
                // Verificar se este dia √© entrada, sa√≠da ou hospedado
                if (entrada === nomeCliente || hospedado === nomeCliente) {
                    // Buscar a entrada desta reserva
                    const dias = document.querySelectorAll(`.dia[data-unidade="${unidade}"]`);
                    for (let d of dias) {
                        if (d.dataset.entrada === nomeCliente) {
                            const diaE = d.dataset.dia;
                            const mesE = d.dataset.mes;
                            const anoE = d.dataset.ano;
                            dataEntrada = `${anoE}-${String(meses.findIndex(m => m.nome === mesE && m.ano == anoE) + 1).padStart(2, '0')}-${String(diaE).padStart(2, '0')}`;
                            break;
                        }
                    }
                }
                
                if (saida === nomeCliente || hospedado === nomeCliente) {
                    // Buscar a sa√≠da desta reserva
                    const dias = document.querySelectorAll(`.dia[data-unidade="${unidade}"]`);
                    for (let d of dias) {
                        if (d.dataset.saida === nomeCliente) {
                            const diaS = d.dataset.dia;
                            const mesS = d.dataset.mes;
                            const anoS = d.dataset.ano;
                            dataSaida = `${anoS}-${String(meses.findIndex(m => m.nome === mesS && m.ano == anoS) + 1).padStart(2, '0')}-${String(diaS).padStart(2, '0')}`;
                            break;
                        }
                    }
                }
                
                // Bot√£o WhatsApp (s√≥ aparece se tiver entrada e sa√≠da)
                let botaoWhatsApp = '';
                if (dataEntrada && dataSaida && clienteInfo.whats) {
                    botaoWhatsApp = `<button class="tooltip-whatsapp-btn" data-nome="${nomeCliente}" data-unidade="${unidade}" data-entrada="${dataEntrada}" data-saida="${dataSaida}">Enviar Confirma√ß√£o</button>`;
                }
                
                tooltipContent += `<div style="border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 5px;">
                        <strong>${clienteInfo.nome}</strong><br>
                        <strong>WhatsApp:</strong> ${clienteInfo.whats || 'N/A'}<br>
                        <strong>Pa√≠s:</strong> ${clienteInfo.pais || 'N/A'}<br>
                        <strong>Temporada:</strong> ${clienteInfo.tempo || 'N/A'}<br>
                        <strong>Unidade Pref.:</strong> ${clienteInfo.unidade || 'N/A'}<br>
                        <strong>Status:</strong> ${clienteInfo.status || 'N/A'}
                        ${botaoWhatsApp}
                    </div>`;
            }
        });
        if (tooltipContent) {
            tooltip.innerHTML = tooltipContent;
        tooltip.querySelectorAll('.tooltip-whatsapp-btn').forEach(btn => {
          btn.addEventListener('click', (ev) => {
            const b = ev.currentTarget;
            enviarConfirmacaoReserva(b.dataset.nome, b.dataset.unidade, b.dataset.entrada, b.dataset.saida);
          });
        });
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY + 15) + 'px';
            tooltip.style.display = 'block';
	    tooltip.classList.add("mostrar");
            
            // Adicionar listeners ao tooltip para mant√™-lo vis√≠vel
            tooltip.onmouseenter = () => {
                clearTimeout(tooltipTimeout);
            };
            tooltip.onmouseleave = () => {
                hideTooltip();
            };
        } else {
            hideTooltip();
        }
    }

    function hideTooltip() {
         const tooltip = document.getElementById('tooltip');
         if(tooltip && !tooltip.matches(':hover')) {
             tooltip.style.display = 'none';
         }
    }

    // ========================================
    // MENU DE CONTEXTO PERSONALIZADO
    // ========================================
    
    function mostrarMenuContexto(event, diaDiv) {
        event.preventDefault();
        
        // Remover menu anterior se existir
        const menuAnterior = document.getElementById('menuContexto');
        if (menuAnterior) menuAnterior.remove();
        
        // Criar menu
        const menu = document.createElement('div');
        menu.id = 'menuContexto';
        menu.style.cssText = `
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            z-index: 10000;
            min-width: 200px;
        `;
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        
        // Verificar se tem reserva na c√©lula
        const nomeCliente = diaDiv.dataset.cliente;
        const unidade = diaDiv.closest('.unidade-coluna').querySelector('h2').textContent;
        const dataEntrada = diaDiv.dataset.entrada;
        const dataSaida = diaDiv.dataset.saida;
        
        // Se tem cliente selecionado, mostrar op√ß√£o de limpar
        if (clienteSelecionado && (dataEntrada || dataSaida)) {
            const opcaoLimpar = document.createElement('div');
            opcaoLimpar.textContent = 'üóëÔ∏è Limpar Reserva';
            opcaoLimpar.style.cssText = `
                padding: 10px 16px;
                cursor: pointer;
                transition: background 0.2s;
            `;
            opcaoLimpar.onmouseover = () => opcaoLimpar.style.background = '#f0f0f0';
            opcaoLimpar.onmouseout = () => opcaoLimpar.style.background = 'white';
            opcaoLimpar.onclick = () => {
                limparDia(diaDiv);
                menu.remove();
            };
            menu.appendChild(opcaoLimpar);
        }
        
        // Se tem reserva, mostrar op√ß√£o de enviar confirma√ß√£o
        if (nomeCliente && dataEntrada && dataSaida) {
            const opcaoWhatsApp = document.createElement('div');
            opcaoWhatsApp.textContent = 'üì± Enviar Confirma√ß√£o';
            opcaoWhatsApp.style.cssText = `
                padding: 10px 16px;
                cursor: pointer;
                transition: background 0.2s;
                color: #25D366;
                font-weight: 500;
            `;
            opcaoWhatsApp.onmouseover = () => opcaoWhatsApp.style.background = '#f0f0f0';
            opcaoWhatsApp.onmouseout = () => opcaoWhatsApp.style.background = 'white';
            opcaoWhatsApp.onclick = () => {
                enviarConfirmacaoReserva(nomeCliente, unidade, dataEntrada, dataSaida);
                menu.remove();
            };
            menu.appendChild(opcaoWhatsApp);
        }
        
        // Se n√£o tem nenhuma op√ß√£o, n√£o mostrar menu
        if (menu.children.length === 0) {
            return;
        }
        
        document.body.appendChild(menu);
        
        // Fechar ao clicar fora
        setTimeout(() => {
            document.addEventListener('click', function fecharMenu() {
                menu.remove();
                document.removeEventListener('click', fecharMenu);
            });
        }, 100);
    }


    // ========================================
    // MENU DE CONTEXTO PERSONALIZADO
    // ========================================
    
    function mostrarMenuContexto(event, diaDiv) {
        event.preventDefault();
        
        // Remover menu anterior se existir
        const menuAnterior = document.getElementById('menuContexto');
        if (menuAnterior) menuAnterior.remove();
        
        // Criar menu
        const menu = document.createElement('div');
        menu.id = 'menuContexto';
        menu.style.cssText = `
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            z-index: 10000;
            min-width: 200px;
        `;
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        
        // Verificar se tem reserva na c√©lula
        const nomeCliente = diaDiv.dataset.cliente;
        const unidade = diaDiv.closest('.unidade-coluna').querySelector('h2').textContent;
        const dataEntrada = diaDiv.dataset.entrada;
        const dataSaida = diaDiv.dataset.saida;
        
        // Se tem cliente selecionado, mostrar op√ß√£o de limpar
        if (clienteSelecionado && (dataEntrada || dataSaida)) {
            const opcaoLimpar = document.createElement('div');
            opcaoLimpar.textContent = 'üóëÔ∏è Limpar Reserva';
            opcaoLimpar.style.cssText = `
                padding: 10px 16px;
                cursor: pointer;
                transition: background 0.2s;
            `;
            opcaoLimpar.onmouseover = () => opcaoLimpar.style.background = '#f0f0f0';
            opcaoLimpar.onmouseout = () => opcaoLimpar.style.background = 'white';
            opcaoLimpar.onclick = () => {
                limparDia(diaDiv);
                menu.remove();
            };
            menu.appendChild(opcaoLimpar);
        }
        
        // Se tem reserva, mostrar op√ß√£o de enviar confirma√ß√£o
        if (nomeCliente && dataEntrada && dataSaida) {
            const opcaoWhatsApp = document.createElement('div');
            opcaoWhatsApp.textContent = 'üì± Enviar Confirma√ß√£o';
            opcaoWhatsApp.style.cssText = `
                padding: 10px 16px;
                cursor: pointer;
                transition: background 0.2s;
                color: #25D366;
                font-weight: 500;
            `;
            opcaoWhatsApp.onmouseover = () => opcaoWhatsApp.style.background = '#f0f0f0';
            opcaoWhatsApp.onmouseout = () => opcaoWhatsApp.style.background = 'white';
            opcaoWhatsApp.onclick = () => {
                enviarConfirmacaoReserva(nomeCliente, unidade, dataEntrada, dataSaida);
                menu.remove();
            };
            menu.appendChild(opcaoWhatsApp);
        }
        
        // Se n√£o tem nenhuma op√ß√£o, n√£o mostrar menu
        if (menu.children.length === 0) {
            return;
        }
        
        document.body.appendChild(menu);
        
        // Fechar ao clicar fora
        setTimeout(() => {
            document.addEventListener('click', function fecharMenu() {
                menu.remove();
                document.removeEventListener('click', fecharMenu);
            });
        }, 100);
    }


    function handleCalendarClick(event) {
        const diaDiv = event.target.closest('.dia');
        if (!diaDiv) return;
        if (segurancaAtivada) { showNotification("Modo de seguran√ßa ativado.", "info"); return; }
        
        if (event.type === 'click') {
            if (clienteSelecionado) {
                registrarReserva(diaDiv);
            }
        }
        // Bot√£o direito: mostrar menu de contexto
        else if (event.type === 'contextmenu') {
            mostrarMenuContexto(event, diaDiv);
        }
        // Duplo clique: limpar reserva (se tiver cliente selecionado)
        else if (event.type === 'dblclick' && clienteSelecionado) {
            limparDia(diaDiv);
        }
    }






    // ========================================
    // CONFIRMA√á√ÉO DE RESERVA POR WHATSAPP
    // ========================================
    
    function enviarConfirmacaoReserva(nomeCliente, unidade, dataEntrada, dataSaida) {
        // Buscar dados do cliente
        const cliente = clientes.find(c => c.nome === nomeCliente);
        if (!cliente) {
            showNotification('Cliente n√£o encontrado!', 'error');
            return;
        }
        
        if (!cliente.whats) {
            showNotification('Cliente n√£o possui WhatsApp cadastrado!', 'error');
            return;
        }
        
        // Calcular n√∫mero de noites
        const entrada = new Date(dataEntrada + 'T00:00:00');
        const saida = new Date(dataSaida + 'T00:00:00');
        const diffTime = Math.abs(saida - entrada);
        const noites = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        // Buscar dados financeiros da reserva (dadosFinanceiros √© um ARRAY)
        const dadosFinanc = dadosFinanceiros.find(d => 
            d.cliente === nomeCliente && 
            d.unidade === unidade
        ) || {};
        
        const valorTotal = parseFloat(dadosFinanc.valor || 0);
        const valorPago = parseFloat(dadosFinanc.pago || 0);
        const saldo = valorTotal - valorPago;
        const metodoPagamento = dadosFinanc.forma || 'N√£o informado';
        const observacoes = dadosFinanc.obs || '';
        
        // Formatar datas
        const formatarData = (dataStr) => {
            const d = new Date(dataStr + 'T00:00:00');
            return d.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        };
        
        // Montar mensagem
        let mensagem = `üèñÔ∏è *CONFIRMA√á√ÉO DE RESERVA* üèñÔ∏è\n\n`;
        mensagem += `Ol√° *${cliente.nome}*! üëã\n\n`;
        mensagem += `Sua reserva foi confirmada com sucesso! Seguem os detalhes:\n\n`;
        
        mensagem += `===================================\n`;
        mensagem += `üìã *DADOS DA RESERVA*\n`;
        mensagem += `===================================\n`;
        mensagem += `üè† *Unidade:* ${unidade}\n`;
        mensagem += `üìÖ *Check-in:* ${formatarData(dataEntrada)}\n`;
        mensagem += `üìÖ *Check-out:* ${formatarData(dataSaida)}\n`;
        mensagem += `üåô *Noites:* ${noites}\n\n`;
        
        if (valorTotal > 0) {
            mensagem += `===================================\n`;
            mensagem += `üí∞ *INFORMA√á√ïES FINANCEIRAS*\n`;
            mensagem += `===================================\n`;
            mensagem += `üíµ *Valor Total:* R$ ${valorTotal.toFixed(2).replace('.', ',')}\n`;
            mensagem += `‚úÖ *Valor Pago:* R$ ${valorPago.toFixed(2).replace('.', ',')}\n`;
            
            if (saldo > 0) {
                mensagem += `‚ö†Ô∏è *Saldo Pendente:* R$ ${saldo.toFixed(2).replace('.', ',')}\n`;
            } else if (saldo < 0) {
                mensagem += `üíö *Cr√©dito:* R$ ${Math.abs(saldo).toFixed(2).replace('.', ',')}\n`;
            } else {
                mensagem += `‚úÖ *Pagamento:* QUITADO\n`;
            }
            
            mensagem += `üí≥ *Forma de Pagamento:* ${metodoPagamento}\n`;
            
            if (observacoes) {
                mensagem += `\nüìù *Observa√ß√µes:*\n${observacoes}\n`;
            }
            
            mensagem += `\n`;
        }
        
        mensagem += `===================================\n`;
        mensagem += `üìû *CONTATO*\n`;
        mensagem += `===================================\n`;
        if (cliente.pais) mensagem += `üåç *Pa√≠s:* ${cliente.pais}\n`;
        mensagem += `üì± *WhatsApp:* ${cliente.whats}\n`;
        
        mensagem += `\n===================================\n\n`;
        mensagem += `‚ú® Estamos ansiosos para receb√™-lo(a)!\n\n`;
        mensagem += `Qualquer d√∫vida, estamos √† disposi√ß√£o! üòä`;
        
        // Limpar n√∫mero de WhatsApp (apenas d√≠gitos)
        const whatsLimpo = cliente.whats.replace(/\D/g, '');
        
        // Gerar link do WhatsApp
        const mensagemEncoded = encodeURIComponent(mensagem);
        const linkWhatsApp = `https://wa.me/${whatsLimpo}?text=${mensagemEncoded}`;
        
        // Abrir WhatsApp
        window.open(linkWhatsApp, '_blank');
        
        showNotification('Abrindo WhatsApp com confirma√ß√£o da reserva...', 'success');
    }

    document.addEventListener('DOMContentLoaded', () => { 
        
        // --- Refer√™ncias DOM
        const clienteSelect = document.getElementById("clienteSelect");
        const container = document.getElementById("calendario-container");
        const mesAtualDisplay = document.getElementById('mesAtualDisplay');
        const mesAnteriorBtn = document.getElementById('mesAnteriorBtn');
        const mesProximoBtn = document.getElementById('mesProximoBtn');
        const filtroResvCheckbox = document.getElementById("filtroResvCheckbox");
        const adicionarClienteBtn = document.getElementById('adicionarClienteBtn');
        const editarClienteBtn = document.getElementById('editarClienteBtn');
        const removerClienteBtn = document.getElementById('removerClienteBtn');
        const segurancaBtn = document.getElementById('segurancaBtn');
        const ajudaBtn = document.getElementById("ajudaBtn");
        const modalAjuda = document.getElementById("modalAjuda");
        const gerarRelatorioBtn = document.getElementById('gerarRelatorioBtn');
        const modalRelatorio = document.getElementById('modalRelatorio');
        const modalCliente = document.getElementById('modalCliente');
        const formCliente = document.getElementById('formCliente');
        const importarClientesBtn = document.getElementById("importarClientesBtn");
        const importarClientesInput = document.getElementById("importarClientesInput");
        const importarBackupCompletoBtn = document.getElementById("importarBackupCompletoBtn");
        const importarBackupCompletoInput = document.getElementById("importarBackupCompletoInput");
        const exportarClientesBtn = document.getElementById('exportarClientesBtn');
        const exportarReservasTXTBtn = document.getElementById('exportarReservasTXTBtn');
        const exportarBackupCompletoBtn = document.getElementById("exportarBackupCompletoBtn");
        const exportarFinanceiroJSONBtn = document.getElementById("exportarFinanceiroJSONBtn");
        const salvarLocalmenteBtn = document.getElementById('salvarLocalmenteBtn');
        const limparDadosLocaisBtn = document.getElementById('limparDadosLocaisBtn');
        const autoBackupToggle = document.getElementById('autoBackupToggle');
        const tooltip = document.getElementById('tooltip');
        const gerenciarFinanceiroBtn = document.getElementById('gerenciarFinanceiroBtn');
        const gerarRelatorioFinanceiroBtn = document.getElementById('gerarRelatorioFinanceiroBtn');
        const modalFinanceiro = document.getElementById('modalFinanceiro');
        const modalRelatorioFinanceiro = document.getElementById('modalRelatorioFinanceiro');
        const formFinanceiro = document.getElementById('formFinanceiro');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const overlay = document.getElementById('overlay');
        const verControleLimpezaBtn = document.getElementById('verControleLimpezaBtn');
        const agendarLimpezaExtraBtn = document.getElementById('agendarLimpezaExtraBtn');
        const modalControleLimpeza = document.getElementById('modalControleLimpeza');
        const modalAgendarLimpeza = document.getElementById('modalAgendarLimpeza');
        const formLimpezaExtra = document.getElementById('formLimpezaExtra');
        const tabelaLimpeza = document.getElementById('tabelaLimpeza');
        const enviarLimpezaWhatsAppBtn = document.getElementById('enviarLimpezaWhatsAppBtn'); // *** ADICIONADO (FEATURE 3) ***
        const configurarTemporadaBtn = document.getElementById('configurarTemporadaBtn');
        const modalConfigurarTemporada = document.getElementById('modalConfigurarTemporada');
        const formConfigurarTemporada = document.getElementById('formConfigurarTemporada');
        const btnResetarPadrao = document.getElementById('btnResetarPadrao');
                
        // --- Inicializa√ß√£o ---
        // Inicializar configura√ß√£o de temporada
        const config = carregarConfiguracao();
        meses = gerarMesesDaConfiguracao(config);
        unidades = config.unidades;
        
        criarCalendario(); 
        carregarDadosLocais();
        sincronizarLimpezasComSaidas(); // Sincroniza limpezas com sa√≠das existentes
        // Event listener para bot√µes de impress√£o (todos)
        const printBtns = document.querySelectorAll('.print-btn');
        printBtns.forEach(btn => {
            // Verifica se o bot√£o √© realmente de impress√£o (n√£o os bot√µes de limpeza)
            if (btn.textContent.includes('Imprimir')) {
                btn.addEventListener('click', () => window.print());
            }
        });
 
        aplicarFiltros(); 

        // --- Adi√ß√£o dos Listeners ---
        window.addEventListener('beforeunload', (e) => { e.preventDefault(); e.returnValue = 'Tem certeza que deseja sair? As altera√ß√µes n√£o salvas podem ser perdidas.'; });
        
        if (menuToggleBtn) menuToggleBtn.addEventListener('click', toggleMenu);
        if (overlay) overlay.addEventListener('click', toggleMenu);

        if (mesAnteriorBtn) mesAnteriorBtn.addEventListener('click', () => { if (mesAtualIndex > 0) { mesAtualIndex--; atualizarVisualizacaoMes(); } });
        if (mesProximoBtn) mesProximoBtn.addEventListener('click', () => { if (mesAtualIndex < meses.length - 1) { mesAtualIndex++; atualizarVisualizacaoMes(); } });        
        // Listener do bot√£o Hoje
        const mesHojeBtn = document.getElementById('mesHojeBtn');
        if (mesHojeBtn) {
            mesHojeBtn.addEventListener('click', () => {
                mesAtualIndex = calcularMesAtual();
                atualizarVisualizacaoMes();
            });
        }
        
        if (clienteSelect) {
            clienteSelect.addEventListener('change', () => {
                clienteSelecionado = clienteSelect.value;
                const desabilitar = !clienteSelecionado;
                if(editarClienteBtn) editarClienteBtn.disabled = desabilitar;
                if(removerClienteBtn) removerClienteBtn.disabled = desabilitar;
                if(gerenciarFinanceiroBtn) gerenciarFinanceiroBtn.disabled = desabilitar;
                aplicarFiltros();
            });
        }
        
        if (filtroResvCheckbox) filtroResvCheckbox.addEventListener('change', () => { preencherListaClientes(clientes); aplicarFiltros(); });
        
        // Bot√£o "Limpar Filtros" removido - funcionalidade obsoleta
        
        if (adicionarClienteBtn) adicionarClienteBtn.addEventListener('click', () => abrirModalCliente('adicionar'));
        if (editarClienteBtn) editarClienteBtn.addEventListener('click', () => { const cliente = clientes.find(c => c.nome === clienteSelect.value); if(cliente) abrirModalCliente('editar', cliente); });
        if (removerClienteBtn) {
            removerClienteBtn.addEventListener('click', () => {
                const nome = clienteSelect.value;
                if (!nome || !confirm(`Tem certeza que deseja remover o cliente "${nome}"?`)) return;
                clientes = clientes.filter(c => c.nome !== nome);
                dadosFinanceiros = dadosFinanceiros.filter(df => !df.idReserva.includes(`-${nome}-`)); 
                salvarDadosFinanceiros(); 
                preencherListaClientes(clientes);
                salvarDadosLocalmente();
                // Limpa sele√ß√£o ap√≥s remover cliente
                if(clienteSelect) clienteSelect.value = "";
                clienteSelecionado = null;
                [editarClienteBtn, removerClienteBtn, gerenciarFinanceiroBtn].forEach(btn => { if(btn) btn.disabled = true; });
                aplicarFiltros();
            });
        }
        
        if (formCliente) formCliente.addEventListener('submit', handleFormClienteSubmit);
        if (modalCliente) modalCliente.querySelector('.modal-close-btn').addEventListener('click', () => modalCliente.style.display = 'none');
        
        if (ajudaBtn) ajudaBtn.addEventListener('click', () => { if(modalAjuda) modalAjuda.style.display = 'flex'; });
        if (modalAjuda) modalAjuda.querySelector('.modal-close-btn').addEventListener('click', () => modalAjuda.style.display = 'none');
        
        if (segurancaBtn) {
            segurancaBtn.addEventListener('click', () => {
              segurancaAtivada = !segurancaAtivada;
              segurancaBtn.innerHTML = segurancaAtivada ? `<i class="bi bi-lock-fill"></i> Seguran√ßa Ativada` : `<i class="bi bi-unlock-fill"></i> Seguran√ßa Desativada`;
              segurancaBtn.classList.toggle('seguranca-ativada', segurancaAtivada);
              document.querySelectorAll('.dia').forEach(dia => dia.classList.toggle('seguranca-ativada', segurancaAtivada));
              showNotification(segurancaAtivada ? "Modo de seguran√ßa ativado." : "Modo de seguran√ßa desativado.", "info");
            });
        }

        if (salvarLocalmenteBtn) salvarLocalmenteBtn.addEventListener('click', salvarDadosLocalmente);
        if (limparDadosLocaisBtn) limparDadosLocaisBtn.addEventListener('click', limparDadosLocais);
        
        // Listeners de Import/Export
        if (importarBackupCompletoBtn) importarBackupCompletoBtn.addEventListener('click', () => { if (importarBackupCompletoInput) importarBackupCompletoInput.click(); });
        if (importarClientesBtn) importarClientesBtn.addEventListener('click', () => { if(importarClientesInput) importarClientesInput.click(); });
        
        if (importarBackupCompletoInput) importarBackupCompletoInput.addEventListener('change', e => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = ev => importarBackupCompleto(ev.target.result); r.readAsText(f); } e.target.value = null; });
        if (importarClientesInput) importarClientesInput.addEventListener('change', e => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = ev => importarListaClientes(ev.target.result); r.readAsText(f); } e.target.value = null; });

        if (exportarBackupCompletoBtn) exportarBackupCompletoBtn.addEventListener('click', exportarBackupCompleto);
        if (exportarClientesBtn) exportarClientesBtn.addEventListener('click', exportarListaClientes);
        if (exportarReservasTXTBtn) exportarReservasTXTBtn.addEventListener('click', exportarReservasTXT);
        if (exportarFinanceiroJSONBtn) exportarFinanceiroJSONBtn.addEventListener('click', exportarFinanceiroJSON);


        // Listeners dos Modais de Relat√≥rio
        if (gerarRelatorioBtn) {
            gerarRelatorioBtn.addEventListener('click', () => { 
                gerarRelatorioDetalhado(); 
                gerarRelatorioVisual(); 
                if(modalRelatorio) {
                    modalRelatorio.style.display = 'flex'; 
                    modalRelatorio.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    modalRelatorio.querySelectorAll('.report-content').forEach(c => c.classList.remove('active'));
                    const tabTexto = modalRelatorio.querySelector('.tab-btn[data-target="relatorioConteudoTexto"]');
                    const contentTexto = document.getElementById('relatorioConteudoTexto');
                    if (tabTexto) tabTexto.classList.add('active');
                    if (contentTexto) contentTexto.classList.add('active');
                }
            });
        }
        if (modalRelatorio) {
            modalRelatorio.querySelector('.modal-close-btn').addEventListener('click', () => modalRelatorio.style.display = 'none');
            modalRelatorio.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    modalRelatorio.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    modalRelatorio.querySelectorAll('.report-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    const targetContent = document.getElementById(btn.dataset.target);
                    if (targetContent) targetContent.classList.add('active');
                });
            });
        }

        // Listeners do M√≥dulo Financeiro
        if (formFinanceiro) formFinanceiro.addEventListener('submit', handleFormFinanceiroSubmit);
        if (modalFinanceiro) modalFinanceiro.querySelector('.modal-close-btn').addEventListener('click', () => modalFinanceiro.style.display = 'none');
        if (gerarRelatorioFinanceiroBtn) gerarRelatorioFinanceiroBtn.addEventListener('click', () => { gerarRelatorioFinanceiro(); if(modalRelatorioFinanceiro) modalRelatorioFinanceiro.style.display = 'flex'; });
        if (modalRelatorioFinanceiro) modalRelatorioFinanceiro.querySelector('.modal-close-btn').addEventListener('click', () => modalRelatorioFinanceiro.style.display = 'none');
        
        if (gerenciarFinanceiroBtn) {
            gerenciarFinanceiroBtn.addEventListener('click', () => {
                const clienteSelect = document.getElementById("clienteSelect");
                if (!clienteSelect) return;
                const clienteNome = clienteSelect.value;
                if (!clienteNome) return;
                const blocosDeReserva = encontrarReservasDoCliente(clienteNome);
                if (blocosDeReserva.length === 0) { showNotification("Nenhuma reserva encontrada para este cliente.", "info"); return; }
                if (blocosDeReserva.length === 1) {
                    abrirModalFinanceiro(blocosDeReserva[0]);
                } else {
                    const listaReservasFinanceiro = document.getElementById('listaReservasFinanceiro');
                    if (!listaReservasFinanceiro) return;
                    listaReservasFinanceiro.innerHTML = '<h4>Selecione uma reserva para editar:</h4>';
                    const f = (d) => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}`;
                    blocosDeReserva.forEach(bloco => {
                        const btn = document.createElement('button');
                        btn.textContent = `Unidade ${bloco.unidade}: de ${f(bloco.inicio.dataObj)} a ${f(bloco.fim.dataObj)}`;
                        btn.onclick = () => abrirModalFinanceiro(bloco);
                        listaReservasFinanceiro.appendChild(btn);
                    });
                    const infoReservaFinanceiro = document.getElementById('infoReservaFinanceiro');
                    const formFinanceiro = document.getElementById('formFinanceiro');
                    const modalFinanceiro = document.getElementById('modalFinanceiro');
                    if(infoReservaFinanceiro) infoReservaFinanceiro.style.display = 'none';
                    if(formFinanceiro) formFinanceiro.style.display = 'none';
                    listaReservasFinanceiro.style.display = 'block';
                    if(modalFinanceiro) modalFinanceiro.style.display = 'flex';
                }
            });
        }

        // Listeners do M√≥dulo de Limpeza
        if (verControleLimpezaBtn) {
            verControleLimpezaBtn.addEventListener('click', () => {
                renderizarControleLimpeza();
                if (modalControleLimpeza) modalControleLimpeza.style.display = 'flex';
            });
        }
        if (agendarLimpezaExtraBtn) {
            agendarLimpezaExtraBtn.addEventListener('click', () => {
                if (formLimpezaExtra) formLimpezaExtra.reset();
                if (modalAgendarLimpeza) modalAgendarLimpeza.style.display = 'flex';
            });
        }
        
        // *** IN√çCIO: MODIFICA√á√ÉO (FEATURE 2) - Limpa flags ao fechar modal ***
        if (modalControleLimpeza) {
            modalControleLimpeza.querySelector('.modal-close-btn').addEventListener('click', () => {
                // Verifica se h√° limpezas editadas antes de fechar
                const totalEditadas = dadosLimpeza.filter(l => l.editada).length;
                if (totalEditadas > 0) {
                    const confirmar = confirm(
                        `‚ö†Ô∏è ATEN√á√ÉO: Existem ${totalEditadas} limpeza(s) ALTERADA(S) que ainda n√£o foram enviadas!\n\n` +
                        `Recomenda-se enviar a lista atualizada para o WhatsApp antes de fechar.\n\n` +
                        `Deseja fechar mesmo assim?`
                    );
                    if (!confirmar) return; // N√£o fecha se o usu√°rio cancelar
                }
                
                modalControleLimpeza.style.display = 'none';
                // Limpa as flags de edi√ß√£o
                dadosLimpeza.forEach(l => l.editada = false);
                ultimaAcaoLimpeza = { acao: null, data: null, unidade: null };
            });
        }
        // *** FIM: MODIFICA√á√ÉO (FEATURE 2) ***
        
        if (tabelaLimpeza) {
            tabelaLimpeza.addEventListener('click', handleTabelaLimpezaClick);
        }
        if (modalAgendarLimpeza) {
            modalAgendarLimpeza.querySelector('.modal-close-btn').addEventListener('click', () => modalAgendarLimpeza.style.display = 'none');
        }
        if (formLimpezaExtra) {
            formLimpezaExtra.addEventListener('submit', (e) => {
                e.preventDefault();
                const unidade = document.getElementById('limpezaUnidadeSelect').value;
                const data = document.getElementById('limpezaDataInput').value;
                const tipo = document.getElementById('limpezaTipoSelect').value;
                const idLimpeza = `${unidade}-${data}-${tipo.replace(' ', '')}-${Date.now()}`; // ID √∫nico para extras
                
                const novaTarefa = { id: idLimpeza, unidade, data, tipo, status: 'Pendente' };
                dadosLimpeza.push(novaTarefa);
                salvarDadosLocalmente();
                showNotification('Limpeza manual agendada!', 'success');
                if (modalAgendarLimpeza) modalAgendarLimpeza.style.display = 'none';
            });
        }
        
        // Listener do Bot√£o Limpar Marca√ß√µes
        const limparMarcacoesBtn = document.getElementById('limparMarcacoesBtn');
        if (limparMarcacoesBtn) {
            limparMarcacoesBtn.addEventListener('click', () => {
                const totalEditadas = dadosLimpeza.filter(t => t.editada).length;
                if (totalEditadas === 0) {
                    showNotification("N√£o h√° marca√ß√µes de edi√ß√£o para limpar.", "info");
                    return;
                }
                
                if (confirm(`Deseja remover a marca√ß√£o de "ALTERADA" de ${totalEditadas} limpeza(s)?\n\nIsso n√£o apagar√° as limpezas, apenas remover√° o destaque visual.`)) {
                    dadosLimpeza.forEach(tarefa => {
                        tarefa.editada = false;
                    });
                    salvarDadosLocalmente();
                    renderizarControleLimpeza();
                    showNotification(`${totalEditadas} marca√ß√£o(√µes) removida(s) com sucesso!`, "success");
                }
            });
        }
        
        // *** IN√çCIO: MODIFICA√á√ÉO (FEATURE 3) - Listener do Bot√£o WhatsApp ***
        if (enviarLimpezaWhatsAppBtn) {
            enviarLimpezaWhatsAppBtn.addEventListener('click', () => {
                if (dadosLimpeza.length === 0) {
                    showNotification("Nenhuma tarefa de limpeza para enviar.", "info");
                    return;
                }
                
                // Ordena os dados por data
                const dadosOrdenados = [...dadosLimpeza].sort((a, b) => new Date(a.data) - new Date(b.data));
                
                // Agrupa por data
                const agrupadoPorData = {};
                dadosOrdenados.forEach(tarefa => {
                    if (!agrupadoPorData[tarefa.data]) {
                        agrupadoPorData[tarefa.data] = [];
                    }
                    agrupadoPorData[tarefa.data].push(tarefa);
                });
                
                // Conta pendentes, conclu√≠das e editadas
                const totalPendentes = dadosOrdenados.filter(t => t.status === 'Pendente').length;
                const totalConcluidas = dadosOrdenados.filter(t => t.status === 'Conclu√≠da').length;
                const totalEditadas = dadosOrdenados.filter(t => t.editada).length;
                
                // Monta a mensagem
                let mensagem = `üßπ *CONTROLE DE LIMPEZA* üßπ\n`;
                mensagem += `üìÖ ${new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n\n`;
                
                // Alerta se houver limpezas editadas
                if (totalEditadas > 0) {
                    mensagem += `üö® *ATEN√á√ÉO: ${totalEditadas} LIMPEZA(S) ALTERADA(S)!* üö®\n`;
                    mensagem += `üîÑ Houve mudan√ßas desde a √∫ltima lista enviada!\n\n`;
                }
                
                mensagem += `üìä *RESUMO:*\n`;
                mensagem += `‚Ä¢ Total: ${dadosOrdenados.length} tarefa(s)\n`;
                mensagem += `‚Ä¢ üî¥ Pendentes: ${totalPendentes}\n`;
                mensagem += `‚Ä¢ ‚úÖ Conclu√≠das: ${totalConcluidas}\n`;
                if (totalEditadas > 0) {
                    mensagem += `‚Ä¢ üîÑ Alteradas: ${totalEditadas}\n`;
                }
                mensagem += `${'='.repeat(35)}\n\n`;
                
                // Adiciona tarefas agrupadas por data
                Object.keys(agrupadoPorData).forEach(data => {
                    const tarefasDoDia = agrupadoPorData[data];
                    const dataF = data.split('-').reverse().join('/');
                    const diaSemana = new Date(data).toLocaleDateString('pt-BR', { weekday: 'short' }).toUpperCase();
                    
                    mensagem += `üìÜ *${diaSemana} - ${dataF}*\n`;
                    
                    tarefasDoDia.forEach(tarefa => {
                        const isPendente = tarefa.status === 'Pendente';
                        const statusEmoji = isPendente ? 'üî¥' : '‚úÖ';
                        
                        // Verifica se a tarefa pendente est√° atrasada ou √© para hoje
                        const hoje = new Date();
                        hoje.setHours(0, 0, 0, 0);
                        const dataLimpeza = new Date(data);
                        dataLimpeza.setHours(0, 0, 0, 0);
                        const isAtrasadaOuHoje = isPendente && dataLimpeza <= hoje;
                        
                        const destaque = isAtrasadaOuHoje ? '‚ö†Ô∏è *URGENTE*' : '';
                        const editadaMarca = tarefa.editada ? 'üîÑ *[ALTERADA]* ' : '';
                        
                        mensagem += `  ${statusEmoji} *${tarefa.unidade}* - ${tarefa.tipo}`;
                        if (editadaMarca) mensagem += ` ${editadaMarca}`;
                        if (destaque) mensagem += ` ${destaque}`;
                        mensagem += `\n`;
                    });
                    
                    mensagem += `\n`;
                });
                
                mensagem += `${'='.repeat(35)}\n`;
                mensagem += `üìå *Legenda:*\n`;
                mensagem += `üî¥ = Pendente (ATEN√á√ÉO!)\n`;
                mensagem += `‚úÖ = Conclu√≠da\n`;
                mensagem += `üîÑ = Alterada (houve mudan√ßa!)\n`;

                const telefone = '5548988252649';
                const textoCodificado = encodeURIComponent(mensagem);
                const urlWhatsApp = `https://wa.me/${telefone}?text=${textoCodificado}`;
                
                window.open(urlWhatsApp, '_blank');
            });
        }
        // *** FIM: MODIFICA√á√ÉO (FEATURE 3) ***


        // Listeners de Configura√ß√£o de Temporada
        if (configurarTemporadaBtn) {
            configurarTemporadaBtn.addEventListener('click', abrirModalConfigurarTemporada);
        }
        if (modalConfigurarTemporada) {
            modalConfigurarTemporada.querySelector('.modal-close-btn').addEventListener('click', () => {
                modalConfigurarTemporada.style.display = 'none';
            });
        }
        if (formConfigurarTemporada) {
            formConfigurarTemporada.addEventListener('submit', aplicarConfiguracoes);
        }
        if (btnResetarPadrao) {
            btnResetarPadrao.addEventListener('click', resetarConfiguracaoPadrao);
        }
        
        // Setup listener para n√∫mero de unidades
        setupNumeroUnidadesListener();
        

        // Listeners de Configura√ß√£o de Temporada
        if (configurarTemporadaBtn) {
            configurarTemporadaBtn.addEventListener('click', abrirModalConfigurarTemporada);
        }
        if (modalConfigurarTemporada) {
            modalConfigurarTemporada.querySelector('.modal-close-btn').addEventListener('click', () => {
                modalConfigurarTemporada.style.display = 'none';
            });
        }
        if (formConfigurarTemporada) {
            formConfigurarTemporada.addEventListener('submit', aplicarConfiguracoes);
        }
        if (btnResetarPadrao) {
            btnResetarPadrao.addEventListener('click', resetarConfiguracaoPadrao);
        }
        
        // Setup listener para n√∫mero de unidades
        setupNumeroUnidadesListener();

        // Listeners do Calend√°rio
        if (container) {
            container.addEventListener('mouseover', gerenciarTooltip);
            container.addEventListener('mouseout', hideTooltip);
            container.addEventListener('click', handleCalendarClick);
            container.addEventListener('dblclick', handleCalendarClick);
            container.addEventListener('contextmenu', handleCalendarClick);
        }

        // *** AVISO AO SAIR DA P√ÅGINA SEM BACKUP ***
        let backupRealizadoNaSessao = false;
        
        // Marca que backup foi realizado quando usu√°rio exporta backup completo
        // (usa a vari√°vel j√° declarada no in√≠cio do DOMContentLoaded)
        if (exportarBackupCompletoBtn) {
            exportarBackupCompletoBtn.addEventListener('click', () => {
                backupRealizadoNaSessao = true;
            });
        }
        
        // Aviso ao tentar sair da p√°gina
        window.addEventListener('beforeunload', (e) => {
            // Verifica se h√° dados e se backup n√£o foi realizado
            const temReservasNoCalendario = document.querySelectorAll('.dia[data-entrada], .dia[data-saida], .dia[data-hospedado]').length > 0;
            const temDados = clientes.length > 0 || dadosFinanceiros.length > 0 || dadosLimpeza.length > 0 || temReservasNoCalendario;
            
            if (temDados && !backupRealizadoNaSessao) {
                const mensagem = '‚ö†Ô∏è ATEN√á√ÉO: Voc√™ n√£o exportou o backup completo nesta sess√£o!\n\nRecomenda-se SEMPRE exportar o backup antes de sair para evitar perda de dados.\n\nDeseja realmente sair?';
                e.preventDefault();
                e.returnValue = mensagem; // Para navegadores antigos
                return mensagem;
            }
        });

    }); // Fim do DOMContentLoaded

})();
  
function enviarConfirmacaoReserva(nome, unidade, entrada, saida) {
  const clienteInfo = clientes.find(c => c.nome === nome);
  if (!clienteInfo) return;
  const mensagem = `Ol√° ${nome}! Sua reserva na unidade ${unidade} est√° confirmada de ${entrada} at√© ${saida}.`;
  navigator.clipboard.writeText(mensagem).then(() => {
    if (confirm('Mensagem copiada! Deseja abrir o WhatsApp agora?')) {
      window.open(`https://wa.me/${clienteInfo.whats}`, '_blank');
    }
  }).catch(() => alert('Falha ao copiar a mensagem.'));
}

</script>

</body>


</html>