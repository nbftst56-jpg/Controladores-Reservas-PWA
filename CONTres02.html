<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Reservas – Temporada 2025/2026</title>

  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <style>
    body { font-family: 'Roboto', sans-serif; margin: 18px; background: #f5f5f5; color:#222; padding-bottom: 90px; }
    h1,h3 { margin:8px 0; }
    .controls { margin-bottom: 14px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .dia {
      min-height:70px; padding:6px 6px 22px 6px; position:relative;
      background:#fff; border:2px solid #ddd; border-radius:8px; cursor:pointer;
      transition: all .18s ease;
      overflow:hidden;
    }
    .dia:hover { border-color:#3f51b5; }
    .dia.vazio { background:transparent; border-color: transparent; cursor:default; box-shadow:none !important; }
    .dia.selecionado { border-color: #1976d2 !important; box-shadow: 0 0 12px rgba(25, 118, 210, 0.5); }

    .numero-dia {
      position:absolute; bottom:6px; left:50%; transform:translateX(-50%);
      font-size:11px; font-weight:700; color:#333; text-align:center;
    }

    .reserva { font-size:11px; text-align:center; margin-top:3px; line-height:1.2; }
    .chip { font-weight: 700; color: #222; padding: 1px 0; }

    .estado-entrada   { background:#dcedc8 !important; border-color: #689f38 !important; }
    .estado-hospedado { background:#ffecb3 !important; border-color: #ffa000 !important; }
    .estado-saida     { background:#ffcdd2 !important; border-color: #d32f2f !important; }
    .dia.multiple { border-color: #444 !important; }

    .dias { display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
    .month { margin-bottom:18px; }
    .unit { margin-bottom:30px; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    #legenda { margin-top:14px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    #legenda .key { display:inline-flex; align-items:center; gap:8px; font-size:13px; }
    .dot { width:16px; height:12px; border-radius:4px; display:inline-block; }
    .dot.entrada { background:#dcedc8; border:2px solid #689f38; }
    .dot.hospedado { background:#ffecb3; border:2px solid #ffa000; }
    .dot.saida { background:#ffcdd2; border:2px solid #d32f2f; }

    .modal-backdrop { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; display:none; }
    .modal {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#fff; border-radius:8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      width:90%; max-width:450px; z-index:1001; padding:20px; display:none;
    }
    .modal h4 { margin-top:0; }
    #modal-reserva .reserva-item { border: 1px solid #ddd; border-radius:6px; padding:10px; margin-bottom:10px; }
    #modal-reserva .reserva-item-actions button { margin-top:8px; margin-right:8px; }

    #agenda .agenda-item {
        border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer;
        display: flex; justify-content: space-between; align-items: center; color: #333;
    }
    #agenda .agenda-data { font-weight: bold; font-size: 16px; }
    #agenda .agenda-info { font-size: 14px; text-align: center; flex-grow: 1; }
    
    #lista-clientes { max-height: 250px; overflow-y: auto; margin: 16px 0; }
    .cliente-item { display:flex; justify-content:space-between; align-items:center; padding: 8px; border-bottom: 1px solid #eee; }
    
    #booking-panel {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: #fff;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        padding: 12px;
        display: flex; flex-wrap: wrap; gap:10px;
        align-items: center; justify-content: center;
        transform: translateY(100%);
        transition: transform 0.3s ease-in-out;
        z-index: 900;
        box-sizing: border-box;
    }
    #booking-panel.visible { transform: translateY(0); }
    #booking-panel-info { text-align:center; flex-grow:1; }
    #booking-panel-info strong { font-size: 16px; }
    #booking-panel .mdl-textfield { width: 200px; }
    #booking-panel-close { position:absolute; top:8px; right:8px; cursor:pointer; color:#888; }
    
    @media (max-width:700px){
      .dias { gap:6px; }
      .dia { min-height:72px; padding-bottom:26px; }
      .controls { flex-direction: column; align-items: stretch; }
      .controls > div, .controls > button { width: 100%; }
      .toolbar { justify-content: center; }
      #booking-panel { flex-direction:column; align-items: stretch; text-align:center; }
      #booking-panel .mdl-textfield { width: 100%; }
    }
  </style>
</head>
<body>
  <h1>📅 Controle de Reservas</h1>
	<a href="index.html">⬅ Voltar</a>

  <div class="controls">
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
      <select id="selUnidade" class="mdl-textfield__input" onchange="renderViews()"></select>
      <label class="mdl-textfield__label" for="selUnidade">Unidade</label>
    </div>
    <div style="display:flex; align-items:center; gap: 5px;">
        <button class="mdl-button mdl-js-button mdl-button--icon" onclick="mudarMes(-1)"><i class="material-icons">chevron_left</i></button>
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="flex-grow:1;">
            <select id="selMes" class="mdl-textfield__input" onchange="renderViews()"></select>
            <label class="mdl-textfield__label" for="selMes">Mês</label>
        </div>
        <button class="mdl-button mdl-js-button mdl-button--icon" onclick="mudarMes(1)"><i class="material-icons">chevron_right</i></button>
    </div>
    <button class="mdl-button mdl-js-button mdl-button--raised" onclick="abrirModalClientes()"><i class="material-icons">people</i>&nbsp;Gerenciar Clientes</button>
    <div class="toolbar">
      <button class="mdl-button mdl-js-button mdl-button--raised" onclick="alternarVisualizacao()"><i class="material-icons">view_agenda</i><span id="btn-view-text">&nbsp;Ver Agenda</span></button>
      <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent" onclick="alternarSeguranca()"><i class="material-icons">security</i>&nbsp;Segurança</button>
      <button class="mdl-button mdl-js-button mdl-button--raised" onclick="onSalvarClick()">💾 Salvar</button>
      <button id="btn-reports" class="mdl-button mdl-js-button mdl-button--raised">📊 Relatórios</button>
      <ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="btn-reports">
        <li class="mdl-menu__item" onclick="exportarOcupacaoDetalhado()">📄 Ocupação (Detalhado)</li>
        <li class="mdl-menu__item" onclick="exportarStatusUnidade()">🗓️ Status por Unidade</li>
        <li class="mdl-menu__item mdl-menu__item--full-bleed-divider"></li>
        <li class="mdl-menu__item" onclick="document.getElementById('fileReservas').click()">⬆️ Importar Reservas (.json)</li>
        <li class="mdl-menu__item" onclick="document.getElementById('fileClientes').click()">⬆️ Importar Clientes (.json)</li>
        <li class="mdl-menu__item" onclick="exportarReservasJSON()">⬇️ Exportar Reservas (.json)</li>
        <li class="mdl-menu__item" onclick="exportarClientesJSON()">⬇️ Exportar Clientes (.json)</li>
      </ul>
    </div>
  </div>

  <div id="view-container"> <div id="calendario"></div> <div id="agenda" style="display:none;"></div> </div>
  <div id="legenda">
    <div class="key"><span class="dot entrada"></span> Entrada</div>
    <div class="key"><span class="dot hospedado"></span> Hospedado</div>
    <div class="key"><span class="dot saida"></span> Saída</div>
  </div>

  <input type="file" id="fileClientes" accept=".json" style="display:none" onchange="importarClientes(event)">
  <input type="file" id="fileReservas" accept=".json" style="display:none" onchange="importarReservas(event)">
  
  <div id="modal-backdrop-reservas" class="modal-backdrop" onclick="fecharModal()"></div>
  <div id="modal-reserva" class="modal">
    <h4 id="modal-title">Reservas no Dia</h4>
    <div id="modal-content"></div>
    <div style="text-align:right; margin-top:20px;">
        <button class="mdl-button mdl-js-button mdl-button--raised" onclick="fecharModal()">Fechar</button>
    </div>
  </div>

  <div id="modal-backdrop-clientes" class="modal-backdrop" onclick="fecharModalClientes()"></div>
  <div id="modal-clientes" class="modal">
      <h4>Gerenciar Clientes</h4> <div id="lista-clientes"></div> <div id="form-cliente"> <h5 id="form-cliente-title">Adicionar Cliente</h5> <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"> <input class="mdl-textfield__input" type="text" id="cliente-nome"> <label class="mdl-textfield__label" for="cliente-nome">Nome</label> </div> <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"> <input class="mdl-textfield__input" type="text" id="cliente-whats"> <label class="mdl-textfield__label" for="cliente-whats">WhatsApp</label> </div> </div> <div style="text-align:right; margin-top:20px;"> <button class="mdl-button mdl-js-button" onclick="fecharModalClientes()">Cancelar</button> <button id="btn-salvar-cliente" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="salvarCliente()">Salvar</button> </div>
  </div>

  <div id="booking-panel">
      <i id="booking-panel-close" class="material-icons" onclick="fecharPainelReserva()">close</i>
      <div id="booking-panel-info">
          Data Selecionada:<br>
          <strong id="panel-data-selecionada">--/--/----</strong>
      </div>
      <div id="panel-actions-container" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center;">
          <div id="panel-client-selector-container" style="display: flex; gap: 10px; align-items: center;">
            <div id="panel-client-selector" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"></div>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="adicionarReservaPeloPainel()">
              <i class="material-icons">add</i>&nbsp;Adicionar
            </button>
          </div>
          <button id="btn-ver-reservas" class="mdl-button mdl-js-button mdl-button--raised" style="display:none;" onclick="abrirModalPeloPainel()">
              <i class="material-icons">edit</i>&nbsp;Ver/Editar
          </button>
      </div>
  </div>

  <div id="snackbar" class="mdl-js-snackbar mdl-snackbar"> <div class="mdl-snackbar__text"></div> <button class="mdl-snackbar__action" type="button"></button> </div>

<script>
/* === DADOS E VARIÁVEIS GLOBAIS === */
function showSnackbar(msg){ document.querySelector('#snackbar').MaterialSnackbar.showSnackbar({message: msg}); }
window.alert = (m) => showSnackbar(m);

let clientes = [ { nome: "FLO", whatsapp: "5835" }, { nome: "RIO", whatsapp: "4412" } ];
const unidades = ["UN01","UN02","UN03"];
const mesesInfo = [ { nome:"Novembro", ns:11, ano:2025 }, { nome:"Dezembro", ns:12, ano:2025 }, { nome:"Janeiro", ns:1, ano:2026 }, { nome:"Fevereiro", ns:2, ano:2026 }, { nome:"Março", ns:3, ano:2026 } ];
let reservas = [];
let modoSeguranca = false, dirty = false;
const estados = ["entrada","hospedado","saida"];
const mapaMes = {"Janeiro":"01","Fevereiro":"02","Março":"03","Novembro":"11","Dezembro":"12"};
let modoVisualizacao = 'calendario', clienteEmEdicao = null;
let dataSelecionada = null;

/* === INICIALIZAÇÃO E RENDERIZAÇÃO === */
function init(){
    carregarLocal();
    initSelects();
    renderViews();
}

function initSelects(){
  const selUn = document.getElementById("selUnidade"); selUn.innerHTML = "";
  unidades.forEach(u => { const o=document.createElement("option"); o.value=u; o.textContent=u; selUn.appendChild(o); });
  const selM = document.getElementById("selMes"); selM.innerHTML = "";
  mesesInfo.forEach((m,i)=> { const o=document.createElement("option"); o.value=i; o.textContent=`${m.nome} ${m.ano}`; selM.appendChild(o); });
}

function renderViews() {
    fecharPainelReserva();
    gerarCalendario();
    gerarAgenda();
    atualizarVisibilidade();
}

function atualizarVisibilidade() {
    const cal = document.getElementById('calendario');
    const agenda = document.getElementById('agenda');
    const legenda = document.getElementById('legenda');
    if (modoVisualizacao === 'calendario') {
        cal.style.display = 'block';
        agenda.style.display = 'none';
        legenda.style.display = 'flex';
    } else {
        cal.style.display = 'none';
        agenda.style.display = 'block';
        legenda.style.display = 'none';
    }
}

/* === LÓGICA DE VISUALIZAÇÃO (CALENDÁRIO E AGENDA) === */
function alternarVisualizacao() {
    modoVisualizacao = (modoVisualizacao === 'calendario') ? 'agenda' : 'calendario';
    const btnIcon = document.querySelector('#btn-view-text').previousElementSibling;
    const btnText = document.querySelector('#btn-view-text');
    if (modoVisualizacao === 'agenda') {
        btnIcon.textContent = 'view_module';
        btnText.innerHTML = '&nbsp;Ver Calendário';
    } else {
        btnIcon.textContent = 'view_agenda';
        btnText.innerHTML = '&nbsp;Ver Agenda';
    }
    atualizarVisibilidade();
}

function mudarMes(direcao) {
    const selM = document.getElementById("selMes");
    let newIndex = selM.selectedIndex + direcao;
    if (newIndex >= 0 && newIndex < selM.options.length) {
        selM.value = newIndex;
        if ('MaterialTextfield' in selM.parentElement) {
            selM.parentElement.MaterialTextfield.checkDirty();
        }
        renderViews();
    }
}

function gerarCalendario(){
  const container = document.getElementById("calendario");
  const selUn = document.getElementById("selUnidade").value || unidades[0];
  const selIdx = parseInt(document.getElementById("selMes").value || 0, 10);
  const mi = mesesInfo[selIdx];
  container.innerHTML = `<div class="unit"><h3>${selUn}</h3><div class="month"><h4>${mi.nome} ${mi.ano}</h4></div></div>`;
  const grid = document.createElement("div"); grid.className = "dias";
  const dUlt = new Date(mi.ano, mi.ns, 0).getDate();
  const primeiroDiaSemana = new Date(mi.ano, mi.ns - 1, 1).getDay();
  for(let i=0; i<42; i++){
    const cell = document.createElement("div");
    const dia = i - primeiroDiaSemana + 1;
    if(i < primeiroDiaSemana || dia > dUlt){
      cell.className = "dia vazio";
    } else {
      cell.className = "dia";
      cell.dataset.unidade = selUn; cell.dataset.mes = mi.nome;
      cell.dataset.ano = mi.ano; cell.dataset.dia = dia;
      cell.innerHTML = `<div class="numero-dia">${dia}</div>`;
      const reservasDia = reservas.filter(r => r.unidade===selUn && r.mes===mi.nome && r.ano===mi.ano && r.dia===dia);
      if(reservasDia.length){
        const statesOrder = ["entrada","hospedado","saida"];
        const uniqStates = [...new Set(reservasDia.map(r=>r.estado))].sort((a,b)=> statesOrder.indexOf(a)-statesOrder.indexOf(b));
        if(uniqStates.length === 1) cell.classList.add(`estado-${uniqStates[0]}`);
        else { cell.classList.add('multiple'); cell.style.background = gradientForStates(uniqStates); }
        reservasDia.forEach(r=>{
          const wrapper = document.createElement("div"); wrapper.className="reserva";
          wrapper.innerHTML = `<div class="chip">${(r.cliente||"").substring(0,4).toUpperCase()}<br>${r.whatsapp?String(r.whatsapp).slice(-4):""}</div>`;
          cell.appendChild(wrapper);
        });
      }
      cell.addEventListener("click", (e) => onDiaClick(cell));
    }
    grid.appendChild(cell);
  }
  container.querySelector('.month').appendChild(grid);
}

const estadoAbbr = { entrada: 'E', hospedado: 'H', saida: 'S' };
function gerarAgenda() {
    const container = document.getElementById("agenda");
    const selUn = document.getElementById("selUnidade").value || unidades[0];
    const selIdx = parseInt(document.getElementById("selMes").value || 0, 10);
    const mi = mesesInfo[selIdx];
    container.innerHTML = `<div class="unit"><h3>${selUn} - ${mi.nome} ${mi.ano}</h3></div>`;
    const reservasMes = ordenarReservas(reservas.filter(r => r.unidade === selUn && r.mes === mi.nome && r.ano === mi.ano));
    if (reservasMes.length === 0) {
        container.innerHTML += `<p class="sem-reservas">Nenhuma reserva encontrada.</p>`;
        return;
    }
    reservasMes.forEach(r => {
        const item = document.createElement('div');
        item.className = `agenda-item estado-${r.estado}`;
        const nome = (r.cliente||"").substring(0,4).toUpperCase();
        const un = unitShort(r.unidade);
        const whats = r.whatsapp ? String(r.whatsapp).slice(-4) : "";
        const estado = estadoAbbr[r.estado] || '?';
        const infoString = `${nome}-${un} (${whats}) - ${estado}`;
        item.innerHTML = `<div class="agenda-data">${String(r.dia).padStart(2, '0')}/${mapaMes[r.mes]}</div><div class="agenda-info">${infoString}</div>`;
        item.onclick = () => onDiaClick(document.querySelector(`.dia[data-dia='${r.dia}']`));
        container.appendChild(item);
    });
}

/* === LÓGICA DE INTERAÇÃO (PAINEL E MODAL) === */
function onDiaClick(cell) {
    if (!cell || cell.classList.contains("vazio")) return;
    const selecionado = document.querySelector('.dia.selecionado');
    if (selecionado) selecionado.classList.remove('selecionado');
    cell.classList.add('selecionado');
    const un = cell.dataset.unidade, mes = cell.dataset.mes;
    const ano = Number(cell.dataset.ano), dia = Number(cell.dataset.dia);
    dataSelecionada = { un, mes, ano, dia };
    abrirPainelReserva();
}

function abrirPainelReserva() {
    const painel = document.getElementById('booking-panel');
    document.getElementById('panel-data-selecionada').textContent = `${dataSelecionada.dia}/${mapaMes[dataSelecionada.mes]}/${dataSelecionada.ano}`;
    const selectorContainer = document.getElementById('panel-client-selector');
    selectorContainer.innerHTML = '<select id="panel-selCliente" class="mdl-textfield__input"></select><label class="mdl-textfield__label" for="panel-selCliente">Cliente</label>';
    const selCli = document.getElementById('panel-selCliente');
    clientes.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(c=>{
        const o = document.createElement("option");
        o.value = `${c.nome}|${c.whatsapp||""}`;
        o.textContent = `${c.nome}${c.whatsapp ? ' – ' + c.whatsapp : ''}`;
        selCli.appendChild(o);
    });
    componentHandler.upgradeElement(selectorContainer.parentElement);

    const reservasDia = reservas.filter(r => r.unidade===dataSelecionada.un && r.mes===dataSelecionada.mes && r.ano===dataSelecionada.ano && r.dia===dataSelecionada.dia);
    document.getElementById('btn-ver-reservas').style.display = (reservasDia.length > 0) ? 'inline-flex' : 'none';

    painel.classList.add('visible');
}

function fecharPainelReserva() {
    const selecionado = document.querySelector('.dia.selecionado');
    if (selecionado) selecionado.classList.remove('selecionado');
    document.getElementById('booking-panel').classList.remove('visible');
    dataSelecionada = null;
}

function adicionarReservaPeloPainel() {
    if (!dataSelecionada || modoSeguranca) return;
    const clienteSel = document.getElementById('panel-selCliente').value;
    if (!clienteSel) { alert("Selecione um cliente."); return; }
    const [nome, whats] = clienteSel.split("|");
    
    const novaReserva = {
        unidade: dataSelecionada.un,
        mes: dataSelecionada.mes,
        ano: dataSelecionada.ano,
        dia: dataSelecionada.dia,
        cliente: nome,
        whatsapp: whats || "",
        estado: "entrada"
    };
    reservas.push(novaReserva);

    dirty = true;
    salvarLocal(true);
    renderViews();
    showSnackbar(`Reserva de ENTRADA criada para ${nome}.`);
}

function abrirModalPeloPainel() {
    if (!dataSelecionada) return;
    const reservasDia = reservas.filter(r => r.unidade===dataSelecionada.un && r.mes===dataSelecionada.mes && r.ano===dataSelecionada.ano && r.dia===dataSelecionada.dia);
    if(reservasDia.length > 0) abrirModal(reservasDia);
}

function abrirModal(reservasDoDia) {
    const rBase = reservasDoDia[0];
    document.getElementById('modal-title').textContent = `Reservas para ${rBase.dia}/${mapaMes[rBase.mes]}/${rBase.ano}`;
    const content = document.getElementById('modal-content');
    content.innerHTML = '';
    reservasDoDia.forEach(r => {
        content.innerHTML += `
          <div class="reserva-item">
            <strong>👤 ${r.cliente}</strong> (${r.whatsapp || '-'})<br>
            <span>Estado: <strong>${r.estado}</strong></span>
            <div class="reserva-item-actions">
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="avancarEstadoReserva('${r.cliente}', ${r.dia})">Avançar Estado</button>
                <button class="mdl-button mdl-js-button" onclick="removerReserva('${r.cliente}', ${r.dia})">Remover</button>
            </div>
          </div>`;
    });
    componentHandler.upgradeElements(content.querySelectorAll('.mdl-button'));
    document.getElementById('modal-backdrop-reservas').style.display = 'block';
    document.getElementById('modal-reserva').style.display = 'block';
}

function fecharModal() { document.getElementById('modal-backdrop-reservas').style.display = 'none'; document.getElementById('modal-reserva').style.display = 'none'; }

function avancarEstadoReserva(cliente, dia) {
    const r = reservas.find(res => res.cliente === cliente && res.dia === dia);
    if (!r) return;
    const idx = estados.indexOf(r.estado);
    r.estado = (idx < estados.length - 1) ? estados[idx+1] : estados[0];
    dirty = true;
    salvarLocal(true);
    renderViews();
    fecharModal();
}

function removerReserva(cliente, dia) {
    if (confirm(`Deseja remover a reserva de ${cliente}?`)) {
        const rIndex = reservas.findIndex(r => r.cliente === cliente && r.dia === dia);
        if (rIndex > -1) {
            reservas.splice(rIndex, 1);
            dirty = true;
            salvarLocal(true);
            renderViews();
            fecharModal();
        }
    }
}

/* === FUNÇÕES DE GERENCIAMENTO DE CLIENTES === */
function abrirModalClientes() { clienteEmEdicao = null; document.getElementById('form-cliente-title').textContent = 'Adicionar Novo Cliente'; document.getElementById('btn-salvar-cliente').textContent = 'Salvar'; document.getElementById('cliente-nome').value = ''; document.getElementById('cliente-whats').value = ''; document.getElementById('cliente-nome').parentElement.MaterialTextfield.change(); document.getElementById('cliente-whats').parentElement.MaterialTextfield.change(); renderizarListaClientes(); document.getElementById('modal-backdrop-clientes').style.display = 'block'; document.getElementById('modal-clientes').style.display = 'block'; }
function fecharModalClientes() { document.getElementById('modal-backdrop-clientes').style.display = 'none'; document.getElementById('modal-clientes').style.display = 'none'; }
function renderizarListaClientes() { const lista = document.getElementById('lista-clientes'); lista.innerHTML = ''; clientes.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(c => { const item = document.createElement('div'); item.className = 'cliente-item'; item.innerHTML = `<span><strong>${c.nome}</strong> - ${c.whatsapp || 'N/A'}</span><div><button class="mdl-button mdl-js-button mdl-button--icon" onclick="editarCliente('${c.nome}')"><i class="material-icons">edit</i></button><button class="mdl-button mdl-js-button mdl-button--icon" onclick="excluirCliente('${c.nome}')"><i class="material-icons">delete</i></button></div>`; lista.appendChild(item); }); componentHandler.upgradeElements(lista.querySelectorAll('.mdl-button')); }
function salvarCliente() { const nomeInput = document.getElementById('cliente-nome'); const whatsInput = document.getElementById('cliente-whats'); const nome = nomeInput.value.trim().toUpperCase(); const whats = whatsInput.value.trim(); if (!nome) { alert("O nome do cliente é obrigatório."); return; } if (clienteEmEdicao) { const cliente = clientes.find(c => c.nome === clienteEmEdicao.nome); if (cliente) { cliente.nome = nome; cliente.whatsapp = whats; } } else { if (clientes.some(c => c.nome === nome)) { alert("Já existe um cliente com este nome."); return; } clientes.push({ nome, whatsapp: whats }); } dirty = true; salvarLocal(true); renderizarListaClientes(); clienteEmEdicao = null; nomeInput.value = ''; whatsInput.value = ''; nomeInput.parentElement.classList.remove('is-dirty'); whatsInput.parentElement.classList.remove('is-dirty'); document.getElementById('form-cliente-title').textContent = 'Adicionar Novo Cliente'; document.getElementById('btn-salvar-cliente').textContent = 'Salvar'; }
function editarCliente(nome) { clienteEmEdicao = clientes.find(c => c.nome === nome); if (clienteEmEdicao) { document.getElementById('cliente-nome').value = clienteEmEdicao.nome; document.getElementById('cliente-whats').value = clienteEmEdicao.whatsapp; document.getElementById('form-cliente-title').textContent = 'Editar Cliente'; document.getElementById('btn-salvar-cliente').textContent = 'Atualizar'; document.getElementById('cliente-nome').parentElement.MaterialTextfield.checkDirty(); document.getElementById('cliente-whats').parentElement.MaterialTextfield.checkDirty(); } }
function excluirCliente(nome) { if (reservas.some(r => r.cliente === nome)) { alert(`Não é possível excluir o cliente "${nome}", pois ele possui reservas ativas.`); return; } if (confirm(`Tem certeza que deseja excluir o cliente "${nome}"?`)) { clientes = clientes.filter(c => c.nome !== nome); dirty = true; salvarLocal(true); renderizarListaClientes(); } }


/* === HELPERS, PERSISTÊNCIA E UTILITÁRIOS === */
function unitShort(u){ const m = u.match(/\d+/); if(m) return "U" + Number(m[0]); return u.replace(/^UN/i,"U"); }
function gradientForStates(estArr){ const mapping = { entrada: "#dcedc8", hospedado: "#ffecb3", saida: "#ffcdd2" }; if(estArr.length === 1) return mapping[estArr[0]]; const colors = estArr.map(s => mapping[s] || "#eee"); const step = 100 / colors.length; return `linear-gradient(135deg, ${colors.map((c,i)=> (i===0? c+' 0%': c + ' ' + Math.round(i*step) + '%')).join(', ')})`; }
function getTimestamp(){ return new Date().toISOString().replace(/[-:T]/g,'').slice(0,15); }
function ordenarReservas(arr){ return [...arr].sort((a,b)=>{ if(a.ano !== b.ano) return a.ano - b.ano; if(a.mes !== b.mes) return (mapaMes[a.mes]||0) - (mapaMes[b.mes]||0); return a.dia - b.dia; }); }
function salvarLocal(silencioso=false){ try{ localStorage.setItem("reservas", JSON.stringify(reservas)); localStorage.setItem("clientes", JSON.stringify(clientes)); }catch(e){ console.error("Erro salvando localStorage", e); } if(!silencioso) console.log("Dados gravados localmente."); }
function onSalvarClick(){ salvarLocal(false); dirty = false; exportarReservasJSON(true); exportarClientesJSON(true); alert("🛡️ Backup gerado (JSON)."); }
function carregarLocal(){ try{ const sRes = localStorage.getItem("reservas"); if(sRes) reservas = JSON.parse(sRes) || []; const sCli = localStorage.getItem("clientes"); if(sCli) clientes = JSON.parse(sCli) || []; }catch(e){ console.warn("erro ao carregar local", e); } dirty = false; }
function baixarBlob(content, filename, mime){ const blob = new Blob([content], { type: mime }); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); setTimeout(()=>URL.revokeObjectURL(a.href), 5000); }
function exportarReservasJSON(){ baixarBlob(JSON.stringify(reservas, null, 2), `reservas_${getTimestamp()}.json`, "application/json"); }
function exportarClientesJSON(){ baixarBlob(JSON.stringify(clientes, null, 2), `clientes_${getTimestamp()}.json`, "application/json"); }
function importarClientes(evt){ const f = evt.target.files[0]; if(!f) return; const fr = new FileReader(); fr.onload = e => { try{ const data = JSON.parse(e.target.result); if(Array.isArray(data)){ clientes = data; initSelects(); salvarLocal(true); dirty = true; alert("👥 Clientes importados."); } else alert("Formato inválido."); }catch(err){ alert("Erro ao importar."); } }; fr.readAsText(f); }
function importarReservas(evt){ const f = evt.target.files[0]; if(!f) return; const fr = new FileReader(); fr.onload = e => { try{ const data = JSON.parse(e.target.result); if(Array.isArray(data)){ reservas = data; salvarLocal(true); renderViews(); dirty = true; alert("📦 Reservas importadas."); } else alert("Formato inválido."); }catch(err){ alert("Erro ao importar."); } }; fr.readAsText(f); }
window.addEventListener('beforeunload', function(e){ if(!dirty) return; salvarLocal(true); e.preventDefault(); e.returnValue = ''; });
function alternarSeguranca(){ modoSeguranca = !modoSeguranca; alert(modoSeguranca ? "🔒 Modo Segurança ATIVADO" : "🔓 Modo Segurança DESATIVADO"); }

/* === NOVAS FUNÇÕES DE RELATÓRIO === */
function formatData(r, dia){ const mm = mapaMes[r.mes] || "00"; const dd = String(dia || r.dia).padStart(2,"0"); return `${dd}/${mm}/${r.ano}`; }

function exportarOcupacaoDetalhado() {
    if (reservas.length === 0) { alert("Nenhuma reserva para gerar relatório."); return; }
    let txt = "=== RELATÓRIO DE OCUPAÇÃO DETALHADO ===\n\n";
    ordenarReservas(reservas).forEach(r => {
        txt += `Data: ${formatData(r)} | Unidade: ${r.unidade} | Cliente: ${r.cliente} (Whats: ${r.whatsapp || 'N/A'}) | Status: ${r.estado}\n`;
    });
    baixarBlob(txt, `relatorio_ocupacao_${getTimestamp()}.txt`, 'text/plain');
}

function exportarStatusUnidade() {
    let txt = `=== STATUS POR UNIDADE (TEMPORADA ${mesesInfo[0].ano}/${mesesInfo[mesesInfo.length-1].ano}) ===\n`;
    unidades.forEach(un => {
        txt += `\n=================================\n`;
        txt += `  UNIDADE: ${un}\n`;
        txt += `=================================\n\n`;
        mesesInfo.forEach(mes => {
            txt += `--- Mês: ${mes.nome} ${mes.ano} ---\n`;
            const diasNoMes = new Date(mes.ano, mes.ns, 0).getDate();
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const dataFormatada = formatData({mes: mes.nome, ano: mes.ano}, dia);
                const reservasDoDia = reservas.filter(r => r.unidade === un && r.mes === mes.nome && r.ano === mes.ano && r.dia === dia);
                
                if (reservasDoDia.length === 0) {
                    txt += `${dataFormatada} - Livre\n`;
                } else {
                    const ocupantes = reservasDoDia.map(r => `${r.cliente} (${r.estado})`).join(', ');
                    txt += `${dataFormatada} - OCUPADO por: ${ocupantes}\n`;
                }
            }
            txt += '\n';
        });
    });
    baixarBlob(txt, `relatorio_status_unidades_${getTimestamp()}.txt`, 'text/plain');
}


// --- INICIALIZAÇÃO DA APLICAÇÃO ---
init();
</script>
</body>
</html>